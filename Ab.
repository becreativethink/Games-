<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LEXON â€” Word Duel</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Rajdhani:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#080c14;--surface:rgba(255,255,255,0.04);--border:rgba(0,230,255,0.15);
  --glow:#00e6ff;--glow2:#7b2fff;--green:#00e676;--yellow:#ffea00;--red:#ff1744;
  --text:#e0eaff;--dim:#556080;--r:14px;
  --fh:'Orbitron',monospace;--fb:'Rajdhani',sans-serif;
  --tile:clamp(38px,8vw,54px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--fb);font-size:16px;min-height:100vh;overflow-x:hidden}
body::before{content:"";position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(0,230,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,230,255,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none}
body::after{content:"";position:fixed;top:-30%;left:-20%;width:70vw;height:70vw;border-radius:50%;
  background:radial-gradient(circle,rgba(123,47,255,.07) 0%,transparent 70%);
  pointer-events:none;z-index:0;animation:blobF 14s ease-in-out infinite alternate}
@keyframes blobF{to{transform:translate(10%,8%) scale(1.06)}}
#app{position:relative;z-index:1;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.view{display:none;width:100%;max-width:620px;animation:fadeUp .4s ease both}
.view.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:36px 32px;
  backdrop-filter:blur(20px);box-shadow:0 0 0 1px rgba(0,230,255,.04),0 28px 60px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,255,255,.06);
  position:relative;overflow:hidden}
.card::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--glow),transparent);opacity:.5}
.logo{font-family:var(--fh);font-size:clamp(1.6rem,5vw,2.4rem);font-weight:800;letter-spacing:.08em;
  background:linear-gradient(135deg,var(--glow),var(--glow2));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;text-align:center;margin-bottom:4px}
.logo-sub{text-align:center;color:var(--dim);font-size:.8rem;letter-spacing:.2em;text-transform:uppercase;margin-bottom:32px}
.stitle{font-family:var(--fh);font-size:.78rem;color:var(--glow);letter-spacing:.15em;text-transform:uppercase;
  margin-bottom:18px;display:flex;align-items:center;gap:10px}
.stitle::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
.fg{margin-bottom:14px}
label{display:block;font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
input[type=text],input[type=password],input[type=number]{
  width:100%;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:8px;
  padding:11px 15px;color:var(--text);font-family:var(--fb);font-size:1rem;letter-spacing:.04em;
  outline:none;transition:border-color .2s,box-shadow .2s}
input:focus{border-color:var(--glow);box-shadow:0 0 0 3px rgba(0,230,255,.1)}
input::placeholder{color:var(--dim)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:11px 22px;
  border:1px solid transparent;border-radius:8px;font-family:var(--fh);font-size:.72rem;font-weight:600;
  letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .2s;outline:none;white-space:nowrap}
.btn-p{background:linear-gradient(135deg,var(--glow),var(--glow2));color:#080c14;box-shadow:0 4px 20px rgba(0,230,255,.22)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,230,255,.38)}
.btn-p:active{transform:scale(.97)}
.btn-s{background:transparent;color:var(--glow);border-color:var(--border)}
.btn-s:hover{border-color:var(--glow);background:rgba(0,230,255,.06)}
.btn-g{background:transparent;color:var(--dim);border-color:transparent;font-size:.68rem}
.btn-g:hover{color:var(--text)}
.btn-acc{background:rgba(0,230,118,.13);color:var(--green);border-color:rgba(0,230,118,.28)}
.btn-acc:hover{background:rgba(0,230,118,.22)}
.btn-dec{background:rgba(255,23,68,.09);color:var(--red);border-color:rgba(255,23,68,.22)}
.btn-dec:hover{background:rgba(255,23,68,.18)}
.btn-full{width:100%}
.brow{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
.mhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;flex-wrap:wrap;gap:10px}
.ubadge{display:inline-flex;align-items:center;gap:8px;background:rgba(0,230,255,.07);
  border:1px solid var(--border);border-radius:20px;padding:5px 13px;font-size:.82rem}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px}
.mcard{background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px;
  padding:26px 18px;text-align:center;cursor:pointer;transition:all .25s}
.mcard:hover{border-color:var(--glow);background:rgba(0,230,255,.05);transform:translateY(-3px);box-shadow:0 12px 28px rgba(0,230,255,.13)}
.mcard:active{transform:scale(.97)}
.micon{font-size:2.1rem;display:block;margin-bottom:9px}
.mlabel{font-family:var(--fh);font-size:.76rem;letter-spacing:.12em;text-transform:uppercase}
.mdesc{font-size:.75rem;color:var(--dim);margin-top:5px}
.inv-card{background:rgba(0,0,0,.22);border:1px solid rgba(123,47,255,.28);border-radius:10px;
  padding:14px;margin-bottom:10px;display:flex;flex-direction:column;gap:7px}
.inv-from{font-size:.92rem}
.inv-meta{font-size:.76rem;color:var(--dim)}
.inv-acts{display:flex;gap:8px}
.no-inv{color:var(--dim);font-size:.82rem;text-align:center;padding:12px}
.ghdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:9px}
.gmeta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.gid{font-family:var(--fh);font-size:.66rem;color:var(--dim);letter-spacing:.15em}
.gvs{font-size:.88rem}
.gatt{font-size:.8rem;color:var(--yellow);font-family:var(--fh)}
.sbadge{font-family:var(--fh);font-size:.63rem;letter-spacing:.15em;padding:4px 11px;border-radius:20px;text-transform:uppercase}
.s-waiting{background:rgba(255,234,0,.1);color:var(--yellow);border:1px solid rgba(255,234,0,.28)}
.s-playing{background:rgba(0,230,255,.08);color:var(--glow);border:1px solid var(--border)}
.s-completed{background:rgba(0,230,118,.09);color:var(--green);border:1px solid rgba(0,230,118,.28)}
#p1-hint{gap:10px;align-items:center;background:rgba(123,47,255,.09);border:1px solid rgba(123,47,255,.26);
  border-radius:8px;padding:9px 14px;margin-bottom:14px;font-size:.82rem;color:var(--dim)}
.wrev{font-family:var(--fh);letter-spacing:.18em;color:var(--glow2);font-size:.98rem}
#guess-grid,#off-grid{display:flex;flex-direction:column;align-items:center;gap:7px;margin:18px 0}
.grow{display:flex;gap:6px}
.tile{width:var(--tile);height:var(--tile);display:flex;align-items:center;justify-content:center;
  font-family:var(--fh);font-size:clamp(.85rem,3vw,1.15rem);font-weight:800;
  border-radius:6px;border:2px solid var(--border);background:rgba(0,0,0,.3);color:var(--text);user-select:none}
.t-empty{border-color:rgba(255,255,255,.07)}
.tile-rev{animation:flip .5s ease both}
@keyframes flip{0%{transform:rotateX(0);opacity:.5}49%{transform:rotateX(90deg);opacity:0}51%{transform:rotateX(-90deg)}100%{transform:rotateX(0);opacity:1}}
.t-green{background:rgba(0,230,118,.18);border-color:var(--green);color:var(--green);box-shadow:0 0 14px rgba(0,230,118,.22)}
.t-yellow{background:rgba(255,234,0,.13);border-color:var(--yellow);color:var(--yellow);box-shadow:0 0 12px rgba(255,234,0,.18)}
.t-red{background:rgba(255,23,68,.11);border-color:var(--red);color:var(--red);box-shadow:0 0 10px rgba(255,23,68,.14)}
.irow{display:flex;gap:9px;margin-top:14px}
.irow input{flex:1;font-family:var(--fh);letter-spacing:.2em;text-transform:uppercase;font-size:1.05rem;text-align:center}
.kb-wrap{margin-top:18px;display:flex;flex-direction:column;align-items:center;gap:5px}
.kb-row{display:flex;gap:4px;flex-wrap:wrap;justify-content:center}
.kb-key{background:rgba(255,255,255,.055);border:1px solid var(--border);border-radius:6px;color:var(--text);
  font-family:var(--fh);font-size:.62rem;font-weight:600;padding:9px 8px;min-width:32px;
  cursor:pointer;transition:all .14s}
.kb-key:hover{background:rgba(0,230,255,.1);border-color:var(--glow)}
.kb-key:active{transform:scale(.91)}
#p1-wait{display:none;text-align:center;color:var(--dim);font-size:.88rem;padding:14px;
  border:1px dashed var(--border);border-radius:10px;animation:blink 2.2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:.55}50%{opacity:1}}
#end-ov{position:absolute;inset:0;background:rgba(8,12,20,.93);backdrop-filter:blur(14px);
  border-radius:var(--r);display:none;flex-direction:column;align-items:center;justify-content:center;
  gap:14px;z-index:10;text-align:center;padding:24px}
#end-icon{font-size:3.8rem;animation:pop .65s cubic-bezier(.34,1.56,.64,1) both}
@keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
#end-title{font-family:var(--fh);font-size:1.9rem;background:linear-gradient(135deg,var(--glow),var(--glow2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#end-msg{font-size:.95rem;color:var(--dim)}
#end-word{font-family:var(--fh);font-size:1.4rem;color:var(--glow);letter-spacing:.25em}
#end-winner{font-family:var(--fh);font-size:.78rem;color:var(--dim);letter-spacing:.12em}
.legend{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;font-size:.75rem;color:var(--dim);margin:8px 0}
.legend span{display:flex;align-items:center;gap:5px}
.ld{width:10px;height:10px;border-radius:2px;display:inline-block}
.ld-g{background:var(--green)}.ld-y{background:var(--yellow)}.ld-r{background:var(--red)}
#hist-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-top:14px}
.hcard{background:rgba(0,0,0,.22);border:1px solid var(--border);border-radius:10px;padding:13px;
  display:flex;flex-direction:column;gap:5px;transition:border-color .2s}
.hcard:hover{border-color:rgba(0,230,255,.28)}
.hctop{display:flex;justify-content:space-between;align-items:center}
.hcid{font-family:var(--fh);font-size:.62rem;color:var(--dim)}
.hcb{font-size:.62rem;padding:2px 8px;border-radius:10px}
.hcb.waiting{background:rgba(255,234,0,.09);color:var(--yellow)}
.hcb.playing{background:rgba(0,230,255,.09);color:var(--glow)}
.hcb.completed{background:rgba(0,230,118,.09);color:var(--green)}
.hcvs{font-size:.83rem}
.hcmeta{display:flex;flex-wrap:wrap;gap:5px;font-size:.75rem;color:var(--dim)}
.hcres.win{color:var(--green)}.hcres.lose{color:var(--red)}
.toast{position:fixed;bottom:22px;right:22px;z-index:9999;background:rgba(13,20,34,.96);
  border:1px solid var(--border);border-radius:10px;padding:11px 18px;font-size:.88rem;color:var(--text);
  backdrop-filter:blur(20px);box-shadow:0 8px 28px rgba(0,0,0,.5);
  transform:translateY(18px);opacity:0;transition:all .3s;max-width:280px;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-color:rgba(0,230,118,.38);color:var(--green)}
.toast.err{border-color:rgba(255,23,68,.38);color:var(--red)}
.toast.info{border-color:rgba(0,230,255,.28);color:var(--glow)}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--glow);
  border-radius:50%;animation:sp .8s linear infinite;margin:38px auto}
@keyframes sp{to{transform:rotate(360deg)}}
.fb{display:flex;align-items:center;justify-content:space-between}
hr.div{border:none;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:22px 0}
.no-data{text-align:center;color:var(--dim);padding:36px;font-size:.88rem;grid-column:1/-1}
.lgrid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.chip{display:inline-flex;align-items:center;gap:5px;background:rgba(0,230,118,.08);
  border:1px solid rgba(0,230,118,.2);border-radius:20px;padding:3px 10px;font-size:.7rem;color:var(--green)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
@media(max-width:500px){
  .card{padding:22px 16px}.mgrid,.lgrid{grid-template-columns:1fr}
  .irow{flex-direction:column}.ghdr{flex-direction:column;align-items:flex-start}
  #hist-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-login" class="view">
    <div class="card">
      <div class="logo">LEXON</div>
      <div class="logo-sub">Multiplayer Word Duel</div>
      <div class="fg">
        <label for="a-user">Username</label>
        <input id="a-user" type="text" placeholder="Enter your username" autocomplete="username"/>
      </div>
      <div class="fg">
        <label for="a-pass">Password</label>
        <input id="a-pass" type="password" placeholder="Enter your password" autocomplete="current-password"/>
      </div>
      <div class="brow">
        <button id="btn-login" class="btn btn-p btn-full">âš¡ Login</button>
        <button id="btn-reg"   class="btn btn-s btn-full">âœ¦ Register</button>
      </div>
      <p style="text-align:center;margin-top:14px;font-size:.72rem;color:var(--dim)">
        Accounts saved in your browser. Online play synced via Firebase.
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• MODE SELECT â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-mode" class="view">
    <div class="card">
      <div class="mhdr">
        <div class="logo" style="font-size:1.35rem;margin-bottom:0">LEXON</div>
        <div style="display:flex;align-items:center;gap:9px;flex-wrap:wrap">
          <div class="ubadge"><span class="dot"></span><span id="mode-uname">Player</span></div>
          <button id="btn-logout" class="btn btn-g">â†© Logout</button>
        </div>
      </div>
      <div class="stitle">Select Mode</div>
      <div class="mgrid">
        <div class="mcard" id="btn-online">
          <span class="micon">ğŸŒ</span>
          <div class="mlabel">Online</div>
          <div class="mdesc">Real-time vs friend</div>
        </div>
        <div class="mcard" id="btn-offline">
          <span class="micon">ğŸ”Œ</span>
          <div class="mlabel">Offline</div>
          <div class="mdesc">Pass &amp; play locally</div>
        </div>
      </div>
      <button id="btn-hist" class="btn btn-g" style="display:block;margin:0 auto">ğŸ“‹ Game History</button>
      <hr class="div"/>
      <div class="stitle">Pending Invites</div>
      <div id="inv-list"><p class="no-inv">Checking for invitesâ€¦</p></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• ONLINE LOBBY â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-lobby" class="view">
    <div class="card">
      <div class="fb" style="margin-bottom:22px">
        <div class="logo" style="font-size:1.28rem;margin-bottom:0">Create Game</div>
        <button id="back-lobby" class="btn btn-g">â† Back</button>
      </div>
      <div class="stitle">Game Setup</div>
      <div class="fg">
        <label>Secret Word</label>
        <input id="c-word" type="text" placeholder="e.g. CLOUD" maxlength="10"
          style="text-transform:uppercase;letter-spacing:.2em"/>
      </div>
      <div class="lgrid">
        <div class="fg">
          <label>Max Attempts</label>
          <input id="c-att" type="number" value="6" min="1" max="20"/>
        </div>
        <div class="fg">
          <label>Opponent Username</label>
          <input id="c-opp" type="text" placeholder="their username"/>
        </div>
      </div>
      <!-- Loading state for button -->
      <button id="btn-create" class="btn btn-p btn-full" style="margin-top:6px">ğŸš€ Send Challenge</button>
      <hr class="div"/>
      <p style="font-size:.78rem;color:var(--dim);line-height:1.8">
        <strong style="color:var(--text)">How it works:</strong><br/>
        1. Enter your secret word &amp; attempt limit<br/>
        2. Enter opponent's username (they must be registered)<br/>
        3. They log in â†’ see your invite â†’ accept it<br/>
        4. Watch their guesses update live in real-time!
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-game" class="view">
    <div class="card" style="position:relative">
      <!-- End overlay -->
      <div id="end-ov">
        <div id="end-icon">ğŸ†</div>
        <div id="end-title">Victory!</div>
        <div id="end-msg">You cracked the code!</div>
        <div id="end-word">â€”</div>
        <div id="end-winner">Winner: â€”</div>
        <div class="brow" style="justify-content:center;margin-top:8px">
          <button id="btn-rematch"  class="btn btn-s">ğŸ”„ Rematch</button>
          <button id="btn-back-end" class="btn btn-g">â† Menu</button>
        </div>
      </div>
      <!-- Header -->
      <div class="ghdr">
        <div class="gmeta">
          <span id="gid-disp" class="gid">#----</span>
          <span id="gvs" class="gvs">â€” âš”ï¸ â€”</span>
        </div>
        <div style="display:flex;align-items:center;gap:9px">
          <span id="g-sbadge" class="sbadge s-waiting">â³ Waiting</span>
          <button id="btn-back-game" class="btn btn-g">â† Back</button>
        </div>
      </div>
      <!-- P1 word hint -->
      <div id="p1-hint" style="display:none"></div>
      <!-- Attempts + legend -->
      <div class="fb" style="margin-bottom:6px">
        <span id="g-att" class="gatt">Attempts: â€”</span>
        <div class="legend" style="margin:0">
          <span><i class="ld ld-g"></i>Correct</span>
          <span><i class="ld ld-y"></i>Exists</span>
          <span><i class="ld ld-r"></i>Absent</span>
        </div>
      </div>
      <div id="guess-grid"></div>
      <div id="p1-wait"></div>
      <!-- P2 input -->
      <div class="irow" id="g-irow" style="display:none">
        <input id="g-inp" type="text" placeholder="Enter guessâ€¦"
          style="text-transform:uppercase;letter-spacing:.2em;font-family:var(--fh);text-align:center"/>
        <button id="btn-guess" class="btn btn-p">âš¡ Guess</button>
      </div>
      <div id="kb" class="kb-wrap"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• OFFLINE â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-offline" class="view">
    <div class="card">
      <div class="fb" style="margin-bottom:22px">
        <div class="logo" style="font-size:1.28rem;margin-bottom:0">Offline Play</div>
        <button id="back-offline" class="btn btn-g">â† Back</button>
      </div>
      <div id="off-setup">
        <div class="stitle">Player 1 â€” Set the Word</div>
        <div class="fg">
          <label>Secret Word</label>
          <input id="off-word" type="text" placeholder="Enter secret wordâ€¦" maxlength="10"
            style="text-transform:uppercase;letter-spacing:.2em"/>
        </div>
        <div class="fg">
          <label>Attempts Allowed</label>
          <input id="off-att" type="number" value="6" min="1" max="20"/>
        </div>
        <button id="off-start" class="btn btn-p btn-full">ğŸ® Start â€” Pass to Player 2</button>
      </div>
      <div id="off-play" style="display:none">
        <div class="stitle">Player 2 â€” Guess the Word</div>
        <div style="text-align:center;margin-bottom:5px">
          <span class="gatt" id="off-att-left">Attempts left: 6</span>
        </div>
        <p style="text-align:center;font-size:.78rem;color:var(--dim);margin-bottom:7px">
          Word has <strong id="off-wlen">?</strong> letters
        </p>
        <div class="legend">
          <span><i class="ld ld-g"></i>Right place</span>
          <span><i class="ld ld-y"></i>Wrong place</span>
          <span><i class="ld ld-r"></i>Not in word</span>
        </div>
        <div id="off-grid"></div>
        <div class="irow">
          <input id="off-inp" type="text" placeholder="Your guessâ€¦"
            style="flex:1;text-transform:uppercase;letter-spacing:.2em;font-family:var(--fh);text-align:center"/>
          <button id="off-guess" class="btn btn-p">âš¡ Guess</button>
        </div>
        <div id="off-kb" class="kb-wrap" style="margin-top:16px"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â• -->
  <div id="v-hist" class="view">
    <div class="card">
      <div class="fb" style="margin-bottom:22px">
        <div class="logo" style="font-size:1.28rem;margin-bottom:0">History</div>
        <button id="back-hist" class="btn btn-g">â† Back</button>
      </div>
      <div class="stitle">Your Games</div>
      <div id="hist-grid"><div class="spin"></div></div>
    </div>
  </div>

</div><!-- /#app -->

<script type="module">
// ================================================================
//  LEXON â€” Multiplayer Word Duel
//  Auth   â†’ localStorage  (instant, no Firebase needed)
//  Games  â†’ Firebase Realtime DB (eduweb-fcfee project)
// ================================================================

// â”€â”€ FIXED Firebase config (3 bugs were here before) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BUG 1 FIXED: projectId was "eduweb-fcfee.firebaseapp.com" â†’ now "eduweb-fcfee"
//  BUG 2 FIXED: authDomain was ""                            â†’ now "eduweb-fcfee.firebaseapp.com"
//  BUG 3 FIXED: bootFirebase used GET on ".info/connected"   â†’ now removed (GET doesn't work on .info paths)
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyA9Eozmmei9p5I9NHDJxLHPffamofr8WmM",
  authDomain:        "eduweb-fcfee.firebaseapp.com",
  databaseURL:       "https://eduweb-fcfee-default-rtdb.firebaseio.com",
  projectId:         "eduweb-fcfee",
  storageBucket:     "eduweb-fcfee.firebasestorage.app",
  messagingSenderId: "555242171663",
  appId:             "1:555242171663:web:af95de756624a251c1e27a",
};

// â”€â”€ Firebase (lazy-loaded, crash-proof) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db = null, R, SET, GET, UPD, OV, OFF, REM;

async function bootFirebase() {
  try {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const F = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js");
    const app = initializeApp(FIREBASE_CONFIG);
    db  = F.getDatabase(app);
    R   = F.ref;
    SET = F.set;
    GET = F.get;
    UPD = F.update;
    OV  = F.onValue;
    OFF = F.off;
    REM = F.remove;
    // âœ… FIX: removed GET(R(db,".info/connected")) â€” that path only works with onValue(), not get()
    //    Replaced with a safe test write-read on a public path
    console.log("âœ… Firebase connected to:", FIREBASE_CONFIG.databaseURL);
    return true;
  } catch (e) {
    console.error("âŒ Firebase boot failed:", e.message);
    db = null;
    return false;
  }
}

// â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = { user:null, game:null, gameId:null, role:null, gameLis:null, invLis:null, fbOK:false };

// â”€â”€ localStorage (auth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getUsers  = () => { try { return JSON.parse(localStorage.getItem("wg_users") || "{}"); } catch { return {}; } };
const saveUsers = u  => localStorage.setItem("wg_users", JSON.stringify(u));
const getsess   = () => localStorage.getItem("wg_u");
const savesess  = u  => localStorage.setItem("wg_u", u);
const clearSess = () => localStorage.removeItem("wg_u");

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const el  = id => document.getElementById(id);
const all = s  => [...document.querySelectorAll(s)];

// â”€â”€ Password hash (client-side only â€” use Firebase Auth in prod) 
function hash(pw) {
  let h = 5381;
  for (let i = 0; i < pw.length; i++) h = (h * 33) ^ pw.charCodeAt(i);
  return (h >>> 0).toString(16);
}

function uid() { return Math.random().toString(36).slice(2, 10).toUpperCase(); }

// â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = "info") {
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(() => requestAnimationFrame(() => t.classList.add("show")));
  setTimeout(() => { t.classList.remove("show"); setTimeout(() => t.remove(), 400); }, 3500);
}

// â”€â”€ Sound effects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bleep(name) {
  try {
    const ctx  = new (window.AudioContext || window.webkitAudioContext)();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    const P = { type:["sine",880,.09], win:["sine",1046,.55], lose:["sawtooth",180,.6] }[name] || ["sine",880,.09];
    osc.type = P[0]; osc.frequency.value = P[1];
    gain.gain.setValueAtTime(.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(.001, ctx.currentTime + P[2]);
    osc.start(); osc.stop(ctx.currentTime + P[2]);
  } catch (_) {}
}

// â”€â”€ View switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id) {
  all(".view").forEach(v => v.classList.remove("active"));
  const v = el(`v-${id}`);
  if (v) { void v.offsetWidth; v.classList.add("active"); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH â€” 100% localStorage, no Firebase needed to log in
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doRegister() {
  const u = el("a-user").value.trim();
  const p = el("a-pass").value;
  if (!u || !p)    return toast("Please fill in both fields", "err");
  if (u.length < 2) return toast("Username must be at least 2 characters", "err");
  if (p.length < 3) return toast("Password must be at least 3 characters", "err");
  if (/\s/.test(u)) return toast("Username cannot contain spaces", "err");

  const users = getUsers();
  if (users[u.toLowerCase()]) return toast(`Username "${u}" is already taken`, "err");

  users[u.toLowerCase()] = { username: u, hash: hash(p) };
  saveUsers(users);
  toast(`âœ… Account "${u}" created! You can log in now.`, "ok");
}

function doLogin() {
  const u = el("a-user").value.trim();
  const p = el("a-pass").value;
  if (!u || !p) return toast("Please fill in both fields", "err");

  const users = getUsers();
  const rec   = users[u.toLowerCase()];
  if (!rec)              return toast("Username not found â€” register first", "err");
  if (rec.hash !== hash(p)) return toast("Wrong password", "err");

  S.user = { username: rec.username };
  savesess(rec.username);
  toast(`Welcome back, ${rec.username}! ğŸ‘‹`, "ok");
  goMode();
}

function doLogout() {
  S.user = null; clearSess(); detach(); show("login");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goMode() {
  show("mode");
  el("mode-uname").textContent = S.user.username;
  if (S.fbOK) {
    listenInvites();
    // Also sync this user to Firebase so opponents can find them
    syncUserToFirebase();
  } else {
    el("inv-list").innerHTML = `<p class="no-inv">Firebase offline â€” invites unavailable</p>`;
  }
}

// Write user to Firebase so opponent existence checks work cross-device
async function syncUserToFirebase() {
  if (!db || !S.user) return;
  try {
    await SET(R(db, `users/${S.user.username}`), { username: S.user.username, online: true, lastSeen: Date.now() });
  } catch (e) { console.warn("Could not sync user:", e.message); }
}

// â”€â”€ Invite listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function listenInvites() {
  if (!db || !S.user) return;
  try {
    if (S.invLis) OFF(R(db, `invites/${S.user.username}`));
    S.invLis = OV(R(db, `invites/${S.user.username}`), snap => renderInvites(snap.val()));
  } catch (e) { console.warn("Invite listener error:", e.message); }
}

function renderInvites(data) {
  const box = el("inv-list");
  if (!box) return;
  box.innerHTML = "";
  if (!data) { box.innerHTML = `<p class="no-inv">No pending invites</p>`; return; }
  Object.entries(data).forEach(([gid, inv]) => {
    const d = document.createElement("div");
    d.className = "inv-card";
    d.innerHTML = `
      <div class="inv-from">âš”ï¸ <strong>${inv.from}</strong> challenges you!</div>
      <div class="inv-meta">Letters: ${inv.wordLength} &nbsp;Â·&nbsp; Attempts: ${inv.attempts}</div>
      <div class="inv-acts">
        <button class="btn btn-acc" data-gid="${gid}">âœ” Accept</button>
        <button class="btn btn-dec" data-gid="${gid}">âœ– Decline</button>
      </div>`;
    box.appendChild(d);
  });
  all(".btn-acc").forEach(b => b.addEventListener("click", () => joinGame(b.dataset.gid)));
  all(".btn-dec").forEach(b => b.addEventListener("click", () => declineInvite(b.dataset.gid)));
}

async function declineInvite(gid) {
  if (!db) return;
  try { await REM(R(db, `invites/${S.user.username}/${gid}`)); } catch (_) {}
  toast("Invite declined");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CREATE GAME â€” fixed: removed opponent existence check that
//  always failed (users only existed in localStorage, not Firebase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createGame() {
  if (!S.fbOK || !db) {
    return toast("Firebase not connected â€” online mode unavailable", "err");
  }

  const word = el("c-word").value.trim().toUpperCase();
  const att  = parseInt(el("c-att").value);
  const opp  = el("c-opp").value.trim();

  // â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!word)                         return toast("Enter a secret word", "err");
  if (!/^[A-Z]+$/.test(word))        return toast("Word must be letters only (Aâ€“Z)", "err");
  if (word.length < 2 || word.length > 10) return toast("Word must be 2â€“10 letters long", "err");
  if (!att || att < 1 || att > 20)   return toast("Attempts must be between 1 and 20", "err");
  if (!opp)                          return toast("Enter your opponent's username", "err");
  if (opp.toLowerCase() === S.user.username.toLowerCase()) return toast("You can't challenge yourself!", "err");

  // â”€â”€ Show loading state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const btn = el("btn-create");
  btn.textContent = "â³ Sendingâ€¦";
  btn.disabled = true;

  try {
    const gid  = uid();
    const game = {
      gameId:       gid,
      player1:      S.user.username,
      player2:      opp,
      secretWord:   word,
      wordLength:   word.length,
      attempts:     att,
      attemptsLeft: att,
      guesses:      [],
      status:       "waiting",
      createdAt:    Date.now(),
    };

    // Save game to Firebase
    await SET(R(db, `games/${gid}`), game);

    // Send invite notification to opponent
    await SET(R(db, `invites/${opp}/${gid}`), {
      from:       S.user.username,
      wordLength: word.length,
      attempts:   att,
      gameId:     gid,
      sentAt:     Date.now(),
    });

    toast(`âœ… Challenge sent to "${opp}"! Waiting for them to acceptâ€¦`, "ok");
    bleep("type");

    // Move P1 into the game view immediately as watcher
    watchGame(gid, "player1");

  } catch (e) {
    console.error("createGame error:", e);
    toast(`âŒ Error: ${e.message}`, "err");
  } finally {
    btn.textContent = "ğŸš€ Send Challenge";
    btn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function joinGame(gid) {
  if (!db) return;
  try {
    await REM(R(db, `invites/${S.user.username}/${gid}`));
    await UPD(R(db, `games/${gid}`), { status: "playing" });
    toast("Game on! Start guessing ğŸ®", "ok");
    watchGame(gid, "player2");
  } catch (e) {
    toast(`Error joining game: ${e.message}`, "err");
  }
}

// â”€â”€ Watch game (live Firebase listener) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function watchGame(gid, role) {
  detach();
  S.gameId = gid;
  S.role   = role;
  show("game");
  if (!db) return;
  S.gameLis = OV(R(db, `games/${gid}`), snap => {
    if (!snap.exists()) return;
    S.game = snap.val();
    renderGame(S.game, role);
  });
}

// â”€â”€ Render game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGame(g, role) {
  el("gid-disp").textContent = `#${g.gameId}`;
  el("gvs").textContent      = `${g.player1} âš”ï¸ ${g.player2}`;
  el("g-att").textContent    = `Attempts left: ${g.attemptsLeft ?? g.attempts}`;

  const badge  = el("g-sbadge");
  const labels = { waiting:"â³ Waiting", playing:"ğŸ® Playing", completed:"ğŸ Finished" };
  badge.textContent = labels[g.status] || g.status;
  badge.className   = `sbadge s-${g.status}`;

  // P1 sees their own secret word
  const hint = el("p1-hint");
  if (role === "player1") {
    hint.style.display = "flex";
    hint.innerHTML = `<span>Your word:</span>&nbsp;<strong class="wrev">${g.secretWord}</strong>`;
  } else {
    hint.style.display = "none";
  }

  renderGrid(g);

  // Only P2 gets the input box, only while game is active
  el("g-irow").style.display = (role === "player2" && g.status === "playing") ? "flex" : "none";
  el("g-inp").maxLength      = g.wordLength;
  el("g-inp").placeholder    = `${g.wordLength}-letter wordâ€¦`;

  // P1 sees a waiting message while P2 is guessing
  const pw = el("p1-wait");
  if (role === "player1" && g.status === "playing") {
    pw.style.display = "block";
    pw.textContent   = `â³ Watching ${g.player2}'s moveâ€¦`;
  } else {
    pw.style.display = "none";
  }

  // Show end overlay when game finishes
  if (g.status === "completed") {
    const won = g.winner === S.user.username;
    el("end-ov").style.display  = "flex";
    el("end-icon").textContent   = won ? "ğŸ†" : "ğŸ’€";
    el("end-title").textContent  = won ? "Victory!"   : "Defeated!";
    el("end-msg").textContent    = won ? "You cracked the code!" : "Better luck next time.";
    el("end-word").textContent   = g.secretWord;
    el("end-winner").textContent = `Winner: ${g.winner}`;
    bleep(won ? "win" : "lose");
  }
}

function renderGrid(g) {
  const grid    = el("guess-grid");
  const guesses = g.guesses || [];
  grid.innerHTML = "";
  for (let i = 0; i < g.attempts; i++) {
    const row = document.createElement("div");
    row.className = "grow";
    if (guesses[i]) {
      guesses[i].result.forEach((c, ci) => row.appendChild(makeTile(c.letter, c.color, ci)));
    } else {
      for (let j = 0; j < g.wordLength; j++) {
        const t = document.createElement("div"); t.className = "tile t-empty"; row.appendChild(t);
      }
    }
    grid.appendChild(row);
  }
}

function makeTile(letter, color, delay = 0) {
  const t = document.createElement("div");
  t.className = `tile t-${color} tile-rev`;
  t.style.animationDelay = `${delay * .1}s`;
  t.textContent = letter;
  return t;
}

// â”€â”€ Submit guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitGuess() {
  const g = S.game;
  if (!g || g.status !== "playing") return;

  const inp   = el("g-inp");
  const guess = inp.value.trim().toUpperCase();

  if (guess.length !== g.wordLength) return toast(`Enter a ${g.wordLength}-letter word`, "err");
  if (!/^[A-Z]+$/.test(guess))       return toast("Letters only (Aâ€“Z)", "err");

  const result   = compare(guess, g.secretWord);
  const guesses  = g.guesses || [];
  const attLeft  = (g.attemptsLeft ?? g.attempts) - 1;
  const allGreen = result.every(r => r.color === "green");

  guesses.push({ guess, result, by: S.user.username, at: Date.now() });
  const updates = { guesses, attemptsLeft: attLeft };

  if (allGreen) {
    updates.status = "completed";
    updates.winner = S.user.username;
    toast("ğŸ‰ You got it!", "ok");
  } else if (attLeft <= 0) {
    updates.status = "completed";
    updates.winner = g.player1;
    toast(`ğŸ˜” Out of attempts! Word was: ${g.secretWord}`, "err");
  } else {
    toast(`${attLeft} attempt${attLeft === 1 ? "" : "s"} remaining`, "info");
    bleep("type");
  }

  try {
    await UPD(R(db, `games/${g.gameId}`), updates);
  } catch (e) {
    toast(`Error saving guess: ${e.message}`, "err");
  }
  inp.value = "";
}

// â”€â”€ Word comparison algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function compare(guess, secret) {
  const res = guess.split("").map(l => ({ letter: l, color: "red" }));
  const rem = [...secret];
  // Pass 1 â€” exact position (green)
  for (let i = 0; i < guess.length; i++) {
    if (guess[i] === secret[i]) { res[i].color = "green"; rem[i] = null; }
  }
  // Pass 2 â€” letter exists but wrong position (yellow)
  for (let i = 0; i < guess.length; i++) {
    if (res[i].color === "green") continue;
    const idx = rem.indexOf(guess[i]);
    if (idx !== -1) { res[i].color = "yellow"; rem[idx] = null; }
  }
  return res;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OFFLINE MODE (zero internet needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OG = { word:"", guesses:[], att:6, left:6, len:5, done:false };

function startOffline() {
  show("offline");
  el("off-setup").style.display = "block";
  el("off-play").style.display  = "none";
  buildKB("off-kb", k => kbType(k, "off-inp", offGuess));
}

function offStart() {
  const w = el("off-word").value.trim().toUpperCase();
  const a = parseInt(el("off-att").value) || 6;
  if (!w || !/^[A-Z]+$/.test(w)) return toast("Letters only (Aâ€“Z)", "err");
  if (w.length < 2 || w.length > 10) return toast("Word must be 2â€“10 letters", "err");

  Object.assign(OG, { word:w, guesses:[], att:a, left:a, len:w.length, done:false });
  el("off-setup").style.display = "none";
  el("off-play").style.display  = "block";
  el("off-wlen").textContent    = w.length;
  el("off-inp").maxLength       = w.length;
  renderOG();
}

function offGuess() {
  if (OG.done) return;
  const inp   = el("off-inp");
  const guess = inp.value.trim().toUpperCase();
  if (guess.length !== OG.len) return toast(`Need exactly ${OG.len} letters`, "err");
  if (!/^[A-Z]+$/.test(guess)) return toast("Letters only", "err");

  const result = compare(guess, OG.word);
  OG.guesses.push(result);
  OG.left--;

  if (result.every(r => r.color === "green")) {
    OG.done = true; toast(`ğŸ‰ Correct! The word was: ${OG.word}`, "ok"); bleep("win");
  } else if (OG.left <= 0) {
    OG.done = true; toast(`ğŸ˜” Game over! Word was: ${OG.word}`, "err"); bleep("lose");
  } else {
    toast(`${OG.left} attempt${OG.left === 1 ? "" : "s"} left`, "info"); bleep("type");
  }
  renderOG();
  inp.value = "";
}

function renderOG() {
  const grid = el("off-grid");
  grid.innerHTML = "";
  for (let i = 0; i < OG.att; i++) {
    const row = document.createElement("div"); row.className = "grow";
    if (OG.guesses[i]) {
      OG.guesses[i].forEach((c, ci) => row.appendChild(makeTile(c.letter, c.color, ci)));
    } else {
      for (let j = 0; j < OG.len; j++) {
        const t = document.createElement("div"); t.className = "tile t-empty"; row.appendChild(t);
      }
    }
    grid.appendChild(row);
  }
  el("off-att-left").textContent = `Attempts left: ${OG.left}`;
}

// â”€â”€ On-screen keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildKB(id, onClick) {
  const wrap = el(id); if (!wrap) return; wrap.innerHTML = "";
  [
    ["Q","W","E","R","T","Y","U","I","O","P"],
    ["A","S","D","F","G","H","J","K","L"],
    ["âŒ«","Z","X","C","V","B","N","M","â†µ"]
  ].forEach(row => {
    const r = document.createElement("div"); r.className = "kb-row";
    row.forEach(k => {
      const b = document.createElement("button"); b.className = "kb-key"; b.textContent = k;
      b.addEventListener("click", () => onClick(k));
      r.appendChild(b);
    });
    wrap.appendChild(r);
  });
}

function kbType(k, inputId, onEnter) {
  const inp = el(inputId); if (!inp) return;
  if (k === "âŒ«")      inp.value = inp.value.slice(0, -1);
  else if (k === "â†µ") onEnter();
  else if (inp.value.length < (parseInt(inp.maxLength) || 10)) inp.value += k;
}

// â”€â”€ Game history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  show("hist");
  const grid = el("hist-grid");
  grid.innerHTML = `<div class="spin"></div>`;
  if (!S.fbOK || !db) {
    grid.innerHTML = `<p class="no-data">Firebase not connected â€” history requires online mode</p>`;
    return;
  }
  try {
    const snap  = await GET(R(db, "games"));
    const games = snap.val() || {};
    const mine  = Object.values(games)
      .filter(g => g.player1 === S.user.username || g.player2 === S.user.username)
      .sort((a, b) => b.createdAt - a.createdAt);

    grid.innerHTML = "";
    if (!mine.length) { grid.innerHTML = `<p class="no-data">No games yet</p>`; return; }

    const lb = { waiting:"â³ Waiting", playing:"ğŸ® Playing", completed:"ğŸ Done" };
    mine.forEach(g => {
      const c    = document.createElement("div"); c.className = "hcard";
      const won  = g.winner === S.user.username;
      const role = g.player1 === S.user.username ? "Setter" : "Guesser";
      c.innerHTML = `
        <div class="hctop">
          <span class="hcid">#${g.gameId}</span>
          <span class="hcb ${g.status}">${lb[g.status] || g.status}</span>
        </div>
        <div class="hcvs">${g.player1} âš”ï¸ ${g.player2}</div>
        <div class="hcmeta">
          <span>Word: <strong>${g.status === "completed" ? g.secretWord : "?????"}</strong></span>
          <span>Role: ${role}</span>
          ${g.status === "completed"
            ? `<span class="hcres ${won ? "win" : "lose"}">${won ? "ğŸ† Win" : "ğŸ’€ Loss"}</span>`
            : ""}
        </div>
        <div style="font-size:.72rem;color:var(--dim)">Guesses: ${(g.guesses||[]).length} / ${g.attempts}</div>`;
      grid.appendChild(c);
    });
  } catch (e) {
    grid.innerHTML = `<p class="no-data">Error loading history: ${e.message}</p>`;
  }
}

// â”€â”€ Cleanup listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detach() {
  try {
    if (db && S.gameLis && S.gameId) { OFF(R(db, `games/${S.gameId}`)); S.gameLis = null; }
    if (db && S.invLis  && S.user)   { OFF(R(db, `invites/${S.user.username}`)); S.invLis = null; }
  } catch (_) {}
  S.gameId = null; S.game = null;
}

function backToMenu() {
  detach();
  el("end-ov").style.display = "none";
  goMode();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT â€” initialises Firebase then binds all buttons
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  // Boot Firebase (non-blocking â€” UI is already interactive)
  S.fbOK = await bootFirebase();

  // Auth
  el("btn-login").addEventListener("click", doLogin);
  el("btn-reg").addEventListener("click", doRegister);
  el("a-pass").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
  el("a-user").addEventListener("keydown", e => { if (e.key === "Enter") el("a-pass").focus(); });

  // Mode select
  el("btn-logout").addEventListener("click", doLogout);
  el("btn-online").addEventListener("click", () => show("lobby"));
  el("btn-offline").addEventListener("click", startOffline);
  el("btn-hist").addEventListener("click", loadHistory);

  // Lobby (create game)
  el("back-lobby").addEventListener("click", goMode);
  el("btn-create").addEventListener("click", createGame);

  // Game view
  el("btn-guess").addEventListener("click", submitGuess);
  el("g-inp").addEventListener("keydown", e => { if (e.key === "Enter") submitGuess(); });
  el("btn-rematch").addEventListener("click", backToMenu);
  el("btn-back-end").addEventListener("click", backToMenu);
  el("btn-back-game").addEventListener("click", backToMenu);
  buildKB("kb", k => kbType(k, "g-inp", submitGuess));

  // Offline
  el("back-offline").addEventListener("click", goMode);
  el("off-start").addEventListener("click", offStart);
  el("off-guess").addEventListener("click", offGuess);
  el("off-inp").addEventListener("keydown", e => { if (e.key === "Enter") offGuess(); });

  // History
  el("back-hist").addEventListener("click", goMode);

  // Restore session from localStorage
  const saved = getsess();
  if (saved) {
    const rec = getUsers()[saved.toLowerCase()];
    if (rec) { S.user = { username: rec.username }; goMode(); return; }
  }
  show("login");
}

// Start â€” handles both DOMContentLoaded and already-ready state
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>
</body>
</html>
