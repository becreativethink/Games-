<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 100px;
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--red);
      letter-spacing: 0.06em;
    }
    .delta-btns { display:flex; gap:6px; }
    .delta-btns input { width:80px; }
    .table-search-wrap { margin-bottom:16px; }
    .analytics-icon { font-size:1.6rem; margin-bottom:8px; display:block; }
  </style>
</head>
<body>

<!-- LOGIN GATE -->
<div id="admin-login" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
  <div class="card" style="max-width:380px;width:100%;text-align:center;">
    <div style="font-size:3rem;margin-bottom:16px;">ğŸ›¡</div>
    <h2 class="mb-8">Admin Access</h2>
    <p class="text-muted text-sm mb-24">This area is restricted. Enter admin credentials.</p>
    <div class="form-group" style="text-align:left;">
      <label>Admin Password</label>
      <input class="form-control" id="admin-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>
    <button class="btn btn-primary btn-full mt-8" onclick="tryAdminLogin()">Access Panel</button>
    <a href="index.html" class="btn btn-secondary btn-full mt-8" style="margin-top:8px;">â† Back to Site</a>
  </div>
</div>

<!-- ADMIN PANEL (hidden until logged in) -->
<div id="admin-panel" class="hidden" style="display:none;">
  <div class="admin-layout">

    <!-- Sidebar -->
    <nav class="admin-sidebar">
      <div class="admin-logo">âš¡ Word<span>War</span> Admin</div>

      <button class="admin-nav-item active" onclick="showSection('analytics')" data-section="analytics">
        <span class="admin-nav-icon">ğŸ“Š</span> Analytics
      </button>
      <button class="admin-nav-item" onclick="showSection('daily')" data-section="daily">
        <span class="admin-nav-icon">ğŸ“…</span> Daily Word
      </button>
      <button class="admin-nav-item" onclick="showSection('users')" data-section="users">
        <span class="admin-nav-icon">ğŸ‘¥</span> Users
      </button>
      <button class="admin-nav-item" onclick="showSection('currency')" data-section="currency">
        <span class="admin-nav-icon">ğŸ’°</span> Currency
      </button>
      <button class="admin-nav-item" onclick="showSection('rankings')" data-section="rankings">
        <span class="admin-nav-icon">ğŸ†</span> Rankings
      </button>

      <div style="flex:1;"></div>
      <button class="admin-nav-item" onclick="adminLogout()" style="color:var(--red);">
        <span class="admin-nav-icon">ğŸšª</span> Logout
      </button>
    </nav>

    <!-- Main content -->
    <main class="admin-main">

      <!-- â”€â”€ ANALYTICS â”€â”€ -->
      <section class="admin-section active" id="section-analytics">
        <div class="flex items-center justify-between mb-24">
          <h2>ğŸ“Š Analytics Dashboard</h2>
          <span class="admin-badge">ğŸ”’ Admin</span>
        </div>

        <div class="analytics-grid" id="analytics-cards">
          <div class="analytics-card"><span class="analytics-icon">ğŸ‘¤</span><span class="val" id="an-users">â€”</span><span class="lbl">Total Users</span></div>
          <div class="analytics-card"><span class="analytics-icon">ğŸ®</span><span class="val" id="an-games">â€”</span><span class="lbl">Total Games</span></div>
          <div class="analytics-card"><span class="analytics-icon">ğŸŒ</span><span class="val" id="an-rooms">â€”</span><span class="lbl">Rooms Created</span></div>
          <div class="analytics-card"><span class="analytics-icon">ğŸ“…</span><span class="val" id="an-daily">â€”</span><span class="lbl">Daily Plays</span></div>
          <div class="analytics-card"><span class="analytics-icon">â­</span><span class="val" id="an-score">â€”</span><span class="lbl">Score in Circulation</span></div>
          <div class="analytics-card"><span class="analytics-icon">ğŸŸ¢</span><span class="val" id="an-online">â€”</span><span class="lbl">Online Now</span></div>
          <div class="analytics-card" style="grid-column:span 2;">
            <span class="analytics-icon">ğŸ…</span>
            <span class="val" id="an-most-active-name">â€”</span>
            <span class="lbl">Most Active Player (<span id="an-most-active-games">â€”</span> games)</span>
          </div>
        </div>

        <button class="btn btn-secondary mt-16" onclick="reloadAnalytics()">â†» Refresh</button>
      </section>

      <!-- â”€â”€ DAILY WORD â”€â”€ -->
      <section class="admin-section hidden" id="section-daily">
        <h2 class="mb-24">ğŸ“… Set Daily Word</h2>

        <div class="card" style="max-width:520px;">
          <div class="form-group">
            <label>Secret Word</label>
            <input class="form-control" id="dw-word" type="text" placeholder="e.g. brave"
                   style="font-family:var(--mono);letter-spacing:0.1em;text-transform:lowercase;" />
          </div>
          <div class="form-group">
            <label>Max Attempts</label>
            <input class="form-control" id="dw-attempts" type="number" value="6" min="3" max="10" />
          </div>
          <div class="form-group">
            <label>Reward Money ğŸ’°</label>
            <input class="form-control" id="dw-money" type="number" value="50" min="0" />
          </div>
          <div class="form-group">
            <label>Reward Score â­</label>
            <input class="form-control" id="dw-score" type="number" value="100" min="0" />
          </div>
          <button class="btn btn-primary mt-8" onclick="saveDailyWord()">Set Daily Word â†’</button>
        </div>

        <!-- Current daily word -->
        <div class="card mt-24" style="max-width:520px;" id="current-daily-card">
          <h3 class="mb-12">Current Daily Word</h3>
          <div id="current-daily-info" class="text-muted text-sm">Loadingâ€¦</div>
        </div>
      </section>

      <!-- â”€â”€ USERS â”€â”€ -->
      <section class="admin-section hidden" id="section-users">
        <div class="section-header">
          <h2>ğŸ‘¥ All Users</h2>
          <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" id="user-search" placeholder="Search usernameâ€¦" oninput="filterUsers()" />
          </div>
        </div>

        <div class="admin-table-wrap">
          <table class="admin-table" id="users-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Username</th>
                <th>Score</th>
                <th>Money</th>
                <th>Wins</th>
                <th>Losses</th>
                <th>Games</th>
                <th>Status</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr><td colspan="9" style="text-align:center;color:var(--text3);padding:32px;">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- â”€â”€ CURRENCY â”€â”€ -->
      <section class="admin-section hidden" id="section-currency">
        <h2 class="mb-24">ğŸ’° Currency Management</h2>

        <div class="card" style="max-width:560px;">
          <div class="form-group">
            <label>Select User</label>
            <select class="form-control" id="cur-user-select">
              <option value="">â€” Choose a user â€”</option>
            </select>
          </div>

          <div class="divider"></div>

          <h3 class="mb-12">Money (ğŸ’°)</h3>
          <div class="delta-btns mb-16">
            <input class="form-control" id="cur-money-amount" type="number" placeholder="Amount" min="1" />
            <button class="btn btn-success btn-sm" onclick="adjustCur('money', 1)">+ Add</button>
            <button class="btn btn-danger btn-sm"  onclick="adjustCur('money', -1)">â€“ Remove</button>
          </div>

          <h3 class="mb-12">Score (â­)</h3>
          <div class="delta-btns">
            <input class="form-control" id="cur-score-amount" type="number" placeholder="Amount" min="1" />
            <button class="btn btn-success btn-sm" onclick="adjustCur('score', 1)">+ Add</button>
            <button class="btn btn-danger btn-sm"  onclick="adjustCur('score', -1)">â€“ Remove</button>
          </div>

          <div id="cur-result" class="mt-16 text-sm text-muted"></div>
        </div>
      </section>

      <!-- â”€â”€ RANKINGS â”€â”€ -->
      <section class="admin-section hidden" id="section-rankings">
        <h2 class="mb-24">ğŸ† Current Rankings</h2>
        <div id="rankings-list" class="leaderboard-list"></div>
      </section>

    </main>
  </div>
</div>

<script type="module">
import { db, ref, onValue, get, update, todayStr } from './firebase-config.js';
import {
  checkAdminAuth, attemptAdminLogin, listenUsers,
  adjustCurrency, setDailyWord, loadAnalytics
} from './admin.js';
import { showToast, avatarUrl, fmtNum } from './main.js';

// â”€â”€ Check admin auth on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  if (checkAdminAuth()) showPanel();
}

window.tryAdminLogin = function() {
  const pass = document.getElementById('admin-pass').value;
  if (attemptAdminLogin(pass)) {
    showPanel();
  } else {
    showToast('Invalid admin credentials.', 'error');
    document.getElementById('admin-pass').value = '';
  }
};

function showPanel() {
  document.getElementById('admin-login').style.display = 'none';
  const panel = document.getElementById('admin-panel');
  panel.classList.remove('hidden');
  panel.style.display = '';
  reloadAnalytics();
  loadUsers();
  loadCurrentDaily();
}

window.adminLogout = function() {
  sessionStorage.removeItem('ww_admin');
  window.location.href = 'index.html';
};

// â”€â”€ Section navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showSection = function(name) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.toggle('active', s.id === `section-${name}`));
  document.querySelectorAll('.admin-section').forEach(s => {
    if (s.id === `section-${name}`) s.classList.add('active');
    else { s.classList.remove('active'); s.classList.add('hidden'); }
  });
  document.getElementById(`section-${name}`).classList.remove('hidden');
  document.querySelectorAll('.admin-nav-item').forEach(b => b.classList.toggle('active', b.dataset.section === name));
};

// â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.reloadAnalytics = async function() {
  const a = await loadAnalytics();
  document.getElementById('an-users').textContent          = a.totalUsers;
  document.getElementById('an-games').textContent          = a.totalGames;
  document.getElementById('an-rooms').textContent          = a.totalRooms;
  document.getElementById('an-daily').textContent          = a.totalDailyPlays;
  document.getElementById('an-score').textContent          = fmtNum(a.totalScore);
  document.getElementById('an-online').textContent         = a.onlineCount;
  document.getElementById('an-most-active-name').textContent  = a.mostActive;
  document.getElementById('an-most-active-games').textContent = a.mostActiveGames;
};

// â”€â”€ Load current daily word â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCurrentDaily() {
  const snap = await get(ref(db, 'dailyWord'));
  const el   = document.getElementById('current-daily-info');
  if (!snap.exists()) { el.textContent = 'No daily word set yet.'; return; }
  const d = snap.val();
  el.innerHTML = `
    <div class="flex justify-between mb-8"><span>Word</span><span class="text-mono text-accent">${d.word?.toUpperCase()}</span></div>
    <div class="flex justify-between mb-8"><span>Date</span><span class="text-mono">${d.date}</span></div>
    <div class="flex justify-between mb-8"><span>Attempts</span><span class="text-mono">${d.attempts}</span></div>
    <div class="flex justify-between mb-8"><span>Reward Money</span><span class="text-mono text-gold">${d.rewardMoney} ğŸ’°</span></div>
    <div class="flex justify-between"><span>Reward Score</span><span class="text-mono text-accent">${d.rewardScore} â­</span></div>
  `;
}

window.saveDailyWord = async function() {
  const word     = document.getElementById('dw-word').value.trim().toLowerCase();
  const attempts = document.getElementById('dw-attempts').value;
  const money    = document.getElementById('dw-money').value;
  const score    = document.getElementById('dw-score').value;

  if (!word || word.length < 3) { showToast('Enter a valid word (min 3 letters).', 'warn'); return; }
  if (!/^[a-z]+$/.test(word))   { showToast('Only letters allowed.', 'warn'); return; }

  await setDailyWord({ word, rewardMoney: money, rewardScore: score, attempts });
  showToast('Daily word set!', 'success');
  loadCurrentDaily();
};

// â”€â”€ Users table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allUsersList = [];

function loadUsers() {
  listenUsers(users => {
    allUsersList = users;

    // Populate currency select
    const sel = document.getElementById('cur-user-select');
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” Choose a user â€”</option>' +
      users.map(u => `<option value="${u.uid}">${u.username}</option>`).join('');
    if (prev) sel.value = prev;

    renderUsersTable(users);
    renderRankings(users);
  });
}

function renderUsersTable(users) {
  const tbody = document.getElementById('users-tbody');
  if (!users.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--text3);">No users.</td></tr>'; return; }

  tbody.innerHTML = users.map((u, i) => `
    <tr>
      <td>${i + 1}</td>
      <td style="color:var(--text);font-weight:700;">${u.username}</td>
      <td class="text-mono text-accent">${fmtNum(u.score||0)}</td>
      <td class="text-mono text-gold">${fmtNum(u.money||0)}</td>
      <td class="text-green">${u.wins||0}</td>
      <td class="text-red">${u.losses||0}</td>
      <td>${u.totalGames||0}</td>
      <td>${u.isOnline ? '<span class="pill pill-green">Online</span>' : '<span style="color:var(--text3);">Offline</span>'}</td>
      <td class="text-muted text-xs">${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'â€”'}</td>
    </tr>`).join('');
}

window.filterUsers = function() {
  const q = document.getElementById('user-search').value.toLowerCase();
  const filtered = allUsersList.filter(u => u.username.toLowerCase().includes(q));
  renderUsersTable(filtered);
};

// â”€â”€ Rankings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRankings(users) {
  const sorted = [...users].sort((a,b) => (b.score||0)-(a.score||0));
  const rankMedals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('rankings-list').innerHTML = sorted.map((u, i) => `
    <div class="lb-item ${i < 3 ? 'rank-'+(i+1) : ''}">
      <span class="lb-rank ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">${rankMedals[i] || '#'+(i+1)}</span>
      <img class="lb-avatar" src="${avatarUrl(u.photoURL, u.username)}" alt="${u.username}" />
      <div class="lb-info">
        <div class="lb-name">${u.username}</div>
        <div class="lb-sub">${u.wins||0} wins Â· ${u.totalGames||0} games</div>
      </div>
      <div class="lb-stats">
        <div>
          <div class="lb-stat-val text-accent">${fmtNum(u.score||0)}</div>
          <div class="lb-stat-lbl">Score</div>
        </div>
        <div>
          <div class="lb-stat-val text-gold">${fmtNum(u.money||0)}</div>
          <div class="lb-stat-lbl">Money</div>
        </div>
      </div>
    </div>`).join('');
}

// â”€â”€ Currency management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.adjustCur = async function(field, sign) {
  const uid = document.getElementById('cur-user-select').value;
  if (!uid) { showToast('Select a user first.', 'warn'); return; }

  const inputId = field === 'money' ? 'cur-money-amount' : 'cur-score-amount';
  const amount = parseInt(document.getElementById(inputId).value, 10);
  if (!amount || amount <= 0) { showToast('Enter a valid amount.', 'warn'); return; }

  const delta = sign * amount;
  try {
    const newVal = await adjustCurrency(uid, field, delta);
    const user   = allUsersList.find(u => u.uid === uid);
    document.getElementById('cur-result').innerHTML =
      `âœ“ <strong>${user?.username}</strong>'s ${field} is now <strong>${fmtNum(newVal)}</strong>`;
    showToast(`${field} updated!`, 'success');
  } catch(e) {
    showToast(e.message, 'error');
  }
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('admin-login').style.display !== 'none') {
    window.tryAdminLogin();
  }
});
</script>
</body>
</html>
