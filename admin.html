<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- â”€â”€ LOGIN GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="admin-login" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
  <div class="card card-elevated" style="max-width:360px;width:100%;text-align:center;">
    <div style="font-size:3rem;margin-bottom:14px;">ğŸ›¡</div>
    <h2 class="mb-8">Admin Access</h2>
    <p class="text-muted text-sm mb-24">Restricted area. Enter your admin password.</p>
    <div class="form-group" style="text-align:left;">
      <label class="form-label">Admin Password</label>
      <input class="form-control" id="admin-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>
    <button class="btn btn-primary btn-full mt-8" onclick="tryAdminLogin()">Access Panel</button>
    <a href="index.html" class="btn btn-ghost btn-full mt-8">â† Back to Site</a>
  </div>
</div>

<!-- â”€â”€ ADMIN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="admin-panel" class="hidden admin-layout">

  <!-- Sidebar -->
  <nav class="admin-sidebar">
    <div class="admin-brand">
      <div class="admin-brand-ico">âš¡</div>
      <span>WordWar <span style="color:var(--accent)">Admin</span></span>
    </div>

    <div class="admin-nav">
      <div class="admin-nav-grp">Overview</div>
      <button class="admin-nav-btn active" data-section="analytics" onclick="showSection('analytics')">
        <span class="admin-nav-ico">ğŸ“Š</span> Analytics
      </button>

      <div class="admin-nav-grp">Game</div>
      <button class="admin-nav-btn" data-section="daily" onclick="showSection('daily')">
        <span class="admin-nav-ico">ğŸ“…</span> Daily Word
      </button>
      <button class="admin-nav-btn" data-section="currency" onclick="showSection('currency')">
        <span class="admin-nav-ico">ğŸ’°</span> Currency
      </button>

      <div class="admin-nav-grp">Players</div>
      <button class="admin-nav-btn" data-section="users" onclick="showSection('users')">
        <span class="admin-nav-ico">ğŸ‘¥</span> All Users
      </button>
      <button class="admin-nav-btn" data-section="rankings" onclick="showSection('rankings')">
        <span class="admin-nav-ico">ğŸ†</span> Rankings
      </button>
    </div>

    <div class="admin-footer">
      <button class="admin-nav-btn" onclick="adminLogout()" style="color:var(--red);">
        <span class="admin-nav-ico">ğŸšª</span> Logout
      </button>
    </div>
  </nav>

  <!-- Main content -->
  <main class="admin-main">

    <!-- ANALYTICS -->
    <section class="admin-section active" id="section-analytics">
      <div class="admin-page-title">
        <h2>ğŸ“Š Analytics Dashboard</h2>
        <p class="text-muted">Platform-wide stats â€” live data</p>
      </div>

      <div class="analytics-grid" id="analytics-cards">
        <div class="analytics-card"><span class="an-icon">ğŸ‘¤</span><span class="an-val" id="an-users">â€”</span><span class="an-lbl">Total Users</span></div>
        <div class="analytics-card"><span class="an-icon">ğŸ®</span><span class="an-val" id="an-games">â€”</span><span class="an-lbl">Total Games</span></div>
        <div class="analytics-card"><span class="an-icon">ğŸŒ</span><span class="an-val" id="an-rooms">â€”</span><span class="an-lbl">Rooms Created</span></div>
        <div class="analytics-card"><span class="an-icon">ğŸ“…</span><span class="an-val" id="an-daily">â€”</span><span class="an-lbl">Daily Plays</span></div>
        <div class="analytics-card"><span class="an-icon">â­</span><span class="an-val" id="an-score">â€”</span><span class="an-lbl">Score in Circulation</span></div>
        <div class="analytics-card"><span class="an-icon">ğŸŸ¢</span><span class="an-val" id="an-online">â€”</span><span class="an-lbl">Online Now</span></div>
        <div class="analytics-card" style="grid-column:span 2;">
          <span class="an-icon">ğŸ…</span>
          <span class="an-val" id="an-active-name">â€”</span>
          <span class="an-lbl">Most Active Player Â· <span id="an-active-games">â€”</span> games</span>
        </div>
      </div>

      <button class="btn btn-ghost btn-sm" onclick="reloadAnalytics()">â†» Refresh Data</button>
    </section>

    <!-- DAILY WORD -->
    <section class="admin-section hidden" id="section-daily">
      <div class="admin-page-title">
        <h2>ğŸ“… Daily Word</h2>
        <p class="text-muted">Set today's challenge word and rewards.</p>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
        <!-- Set form -->
        <div class="card card-elevated">
          <h3 class="mb-16">Set New Daily Word</h3>
          <div class="form-group">
            <label class="form-label">Secret Word</label>
            <input class="form-control" id="dw-word" type="text" placeholder="e.g. brave"
                   style="text-transform:lowercase;letter-spacing:0.08em;" />
          </div>
          <div class="flex gap-12">
            <div class="form-group flex-1">
              <label class="form-label">Max Attempts</label>
              <input class="form-control" id="dw-attempts" type="number" value="6" min="3" max="10" />
            </div>
            <div class="form-group flex-1">
              <label class="form-label">Reward Money ğŸ’°</label>
              <input class="form-control" id="dw-money" type="number" value="50" min="0" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Reward Score â­</label>
            <input class="form-control" id="dw-score" type="number" value="100" min="0" />
          </div>
          <button class="btn btn-primary mt-8" onclick="saveDailyWord()">Set Daily Word â†’</button>
        </div>

        <!-- Current daily -->
        <div class="card card-elevated">
          <h3 class="mb-16">Current Daily Word</h3>
          <div id="current-daily-info" class="text-muted text-sm">Loadingâ€¦</div>
        </div>
      </div>
    </section>

    <!-- USERS -->
    <section class="admin-section hidden" id="section-users">
      <div class="admin-page-title">
        <h2>ğŸ‘¥ All Users</h2>
        <p class="text-muted">Complete user registry with live stats.</p>
      </div>

      <div class="section-head">
        <span class="text-muted text-sm" id="user-count">Loadingâ€¦</span>
        <div class="search-bar">
          <span class="search-ic">ğŸ”</span>
          <input type="text" id="user-search" placeholder="Search by usernameâ€¦" oninput="filterUsers()" />
        </div>
      </div>

      <div class="tbl-wrap">
        <table class="data-table" id="users-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Score</th>
              <th>Money</th>
              <th>Wins</th>
              <th>Losses</th>
              <th>Games</th>
              <th>Status</th>
              <th>Joined</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CURRENCY -->
    <section class="admin-section hidden" id="section-currency">
      <div class="admin-page-title">
        <h2>ğŸ’° Currency Management</h2>
        <p class="text-muted">Add or remove money and score from any user.</p>
      </div>

      <div class="card card-elevated" style="max-width:520px;">
        <div class="form-group">
          <label class="form-label">Select User</label>
          <select class="form-control" id="cur-user-select">
            <option value="">â€” Choose a user â€”</option>
          </select>
        </div>

        <div class="divider"></div>

        <h3 class="mb-12">ğŸ’° Money</h3>
        <div class="amount-row mb-16">
          <input class="form-control" id="cur-money-amount" type="number" placeholder="Amount" min="1" />
          <button class="btn btn-success btn-sm" onclick="adjustCur('money',1)">ï¼‹ Add</button>
          <button class="btn btn-danger btn-sm"  onclick="adjustCur('money',-1)">ï¼ Remove</button>
        </div>

        <h3 class="mb-12">â­ Score</h3>
        <div class="amount-row">
          <input class="form-control" id="cur-score-amount" type="number" placeholder="Amount" min="1" />
          <button class="btn btn-success btn-sm" onclick="adjustCur('score',1)">ï¼‹ Add</button>
          <button class="btn btn-danger btn-sm"  onclick="adjustCur('score',-1)">ï¼ Remove</button>
        </div>

        <div id="cur-result" class="mt-16 text-sm text-muted"></div>
      </div>
    </section>

    <!-- RANKINGS -->
    <section class="admin-section hidden" id="section-rankings">
      <div class="admin-page-title">
        <h2>ğŸ† Live Rankings</h2>
        <p class="text-muted">Current player standings by score.</p>
      </div>
      <div class="lb-list" id="rankings-list">
        <div class="text-center text-muted" style="padding:40px;">Loadingâ€¦</div>
      </div>
    </section>

  </main>
</div>

<script type="module">
import { db, ref, get } from './firebase-config.js';
import { checkAdminAuth, attemptAdminLogin, listenUsers, adjustCurrency, setDailyWord, loadAnalytics } from './admin.js';
import { showToast, avatarUrl, fmtNum } from './main.js';

function init() {
  if (checkAdminAuth()) showPanel();
}

window.tryAdminLogin = function() {
  const pass = document.getElementById('admin-pass').value;
  if (attemptAdminLogin(pass)) {
    showPanel();
  } else {
    showToast('Invalid admin credentials.', 'error');
    document.getElementById('admin-pass').value = '';
  }
};

function showPanel() {
  document.getElementById('admin-login').style.display = 'none';
  const panel = document.getElementById('admin-panel');
  panel.classList.remove('hidden');
  reloadAnalytics();
  loadUsers();
  loadCurrentDaily();
}

window.adminLogout = function() {
  sessionStorage.removeItem('ww_admin');
  window.location.href = 'index.html';
};

// â”€â”€ Section navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showSection = function(name) {
  document.querySelectorAll('.admin-section').forEach(s => {
    const active = s.id === `section-${name}`;
    s.classList.toggle('active', active);
    s.classList.toggle('hidden', !active);
  });
  document.querySelectorAll('.admin-nav-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.section === name);
  });
};

// â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.reloadAnalytics = async function() {
  const a = await loadAnalytics();
  document.getElementById('an-users').textContent       = a.totalUsers;
  document.getElementById('an-games').textContent       = a.totalGames;
  document.getElementById('an-rooms').textContent       = a.totalRooms;
  document.getElementById('an-daily').textContent       = a.totalDailyPlays;
  document.getElementById('an-score').textContent       = fmtNum(a.totalScore);
  document.getElementById('an-online').textContent      = a.onlineCount;
  document.getElementById('an-active-name').textContent = a.mostActive;
  document.getElementById('an-active-games').textContent= a.mostActiveGames;
};

// â”€â”€ Daily word â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCurrentDaily() {
  const snap = await get(ref(db, 'dailyWord'));
  const el   = document.getElementById('current-daily-info');
  if (!snap.exists()) { el.innerHTML = '<span class="text-faint">No daily word set yet.</span>'; return; }
  const d = snap.val();
  el.innerHTML = `
    <div class="flex justify-between mb-12"><span class="text-muted">Word</span><strong class="text-mono text-accent" style="font-size:1.1rem;letter-spacing:0.15em;">${d.word?.toUpperCase()}</strong></div>
    <div class="flex justify-between mb-8"><span class="text-muted">Date</span><span class="text-mono">${d.date}</span></div>
    <div class="flex justify-between mb-8"><span class="text-muted">Attempts allowed</span><span class="text-mono">${d.attempts}</span></div>
    <div class="flex justify-between mb-8"><span class="text-muted">Reward Money</span><span class="text-mono text-gold">${d.rewardMoney} ğŸ’°</span></div>
    <div class="flex justify-between"><span class="text-muted">Reward Score</span><span class="text-mono text-accent">${d.rewardScore} â­</span></div>`;
}

window.saveDailyWord = async function() {
  const word     = document.getElementById('dw-word').value.trim().toLowerCase();
  const attempts = document.getElementById('dw-attempts').value;
  const money    = document.getElementById('dw-money').value;
  const score    = document.getElementById('dw-score').value;

  if (!word || word.length < 2)  { showToast('Enter a valid word (min 2 letters).', 'warn'); return; }
  if (!/^[a-z]+$/.test(word))    { showToast('Letters only.', 'warn'); return; }

  await setDailyWord({ word, rewardMoney: money, rewardScore: score, attempts });
  showToast('Daily word set!', 'success');
  loadCurrentDaily();
};

// â”€â”€ Users table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allUsersList = [];

function loadUsers() {
  listenUsers(users => {
    allUsersList = users;
    document.getElementById('user-count').textContent = `${users.length} users`;

    // Currency select
    const sel  = document.getElementById('cur-user-select');
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” Choose a user â€”</option>' +
      users.map(u => `<option value="${u.uid}">${u.username}</option>`).join('');
    if (prev) sel.value = prev;

    renderTable(users);
    renderRankings(users);
  });
}

function renderTable(users) {
  const tbody = document.getElementById('users-tbody');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);">No users found.</td></tr>';
    return;
  }

  tbody.innerHTML = users.map((u, i) => `
    <tr>
      <td>${i + 1}</td>
      <td class="col-name">${u.username}</td>
      <td><span class="text-mono text-accent">${fmtNum(u.score||0)}</span></td>
      <td><span class="text-mono text-gold">${fmtNum(u.money||0)}</span></td>
      <td class="text-green">${u.wins||0}</td>
      <td class="text-red">${u.losses||0}</td>
      <td class="text-muted">${u.totalGames||0}</td>
      <td>${u.isOnline
        ? '<span class="tag tag-green" style="font-size:0.65rem;">Online</span>'
        : '<span style="color:var(--text3);font-size:0.75rem;">Offline</span>'}</td>
      <td class="text-faint text-xs">${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'â€”'}</td>
    </tr>`).join('');
}

window.filterUsers = function() {
  const q = document.getElementById('user-search').value.toLowerCase();
  renderTable(allUsersList.filter(u => u.username.toLowerCase().includes(q)));
};

function renderRankings(users) {
  const sorted   = [...users].sort((a,b) => (b.score||0)-(a.score||0));
  const medals   = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rkClasses = ['r1','r2','r3'];
  const rnkClss   = ['gold','silver','bronze'];

  document.getElementById('rankings-list').innerHTML = sorted.map((u, i) => `
    <div class="lb-item ${rkClasses[i] || ''}">
      <span class="lb-rank ${rnkClss[i] || ''}">${medals[i] || '#'+(i+1)}</span>
      <img class="lb-avatar" src="${avatarUrl(u.photoURL, u.username)}" alt="${u.username}" />
      <div class="lb-info">
        <div class="lb-name">${u.username}</div>
        <div class="lb-sub">${u.wins||0} wins Â· ${u.totalGames||0} games</div>
      </div>
      <div class="lb-stats">
        <div class="lb-stat">
          <span class="lb-stat-val text-accent">${fmtNum(u.score||0)}</span>
          <span class="lb-stat-lbl">Score</span>
        </div>
        <div class="lb-stat">
          <span class="lb-stat-val text-gold">${fmtNum(u.money||0)}</span>
          <span class="lb-stat-lbl">Money</span>
        </div>
      </div>
    </div>`).join('');
}

// â”€â”€ Currency management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.adjustCur = async function(field, sign) {
  const uid = document.getElementById('cur-user-select').value;
  if (!uid) { showToast('Select a user first.', 'warn'); return; }

  const inputId = field === 'money' ? 'cur-money-amount' : 'cur-score-amount';
  const amount  = parseInt(document.getElementById(inputId).value, 10);
  if (!amount || amount <= 0) { showToast('Enter a valid amount.', 'warn'); return; }

  try {
    const newVal = await adjustCurrency(uid, field, sign * amount);
    const u      = allUsersList.find(u => u.uid === uid);
    document.getElementById('cur-result').innerHTML =
      `âœ“ <strong>${u?.username}'s</strong> ${field} updated to <strong class="text-mono">${fmtNum(newVal)}</strong>`;
    showToast(`${u?.username}'s ${field} updated!`, 'success');
  } catch(e) {
    showToast(e.message, 'error');
  }
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('admin-login').style.display !== 'none') {
    window.tryAdminLogin();
  }
});
</script>
</body>
</html>
