<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Game</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* â”€â”€ Loading indicator shown before JS runs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading-cover {
      position: fixed; inset: 0; background: var(--bg, #05050d);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 14px;
      z-index: 500; transition: opacity 0.3s;
    }
    #loading-cover .spin {
      width: 36px; height: 36px; border-radius: 50%;
      border: 3px solid rgba(109,81,245,0.15);
      border-top-color: #6d51f5;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-cover p { color: #7878a0; font-family: 'Outfit',sans-serif; font-size: 0.82rem; }

    /* â”€â”€ Ad banner: iframe approach avoids document.write wipe â”€â”€ */
    .ad-banner {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      display: flex; justify-content: center; align-items: center;
      background: #0e0e1e;
      border-top: 1px solid rgba(255,255,255,0.07);
      min-height: 60px;
      z-index: 400;            /* below navbar (200) â€¦ wait, navbar is 200 */
    }
    /* iframe wrapper so document.write is sandboxed */
    .ad-banner iframe {
      border: none; width: 320px; height: 50px;
      display: block; overflow: hidden;
    }
    /* Push all page content above the ad */
    body { padding-bottom: 70px; }
  </style>
</head>
<body>

<!-- Loading cover â€” shown until JS initialises correctly -->
<div id="loading-cover">
  <div class="spin"></div>
  <p>Loading gameâ€¦</p>
</div>

<!-- Navbar -->
<nav class="navbar">
  <a href="index.html" class="nav-logo"><span class="w1">WORD</span><span class="w2">WAR</span></a>
  <div class="nav-links">
    <a href="index.html" class="nav-link m-show">â† Home</a>
    <div class="nav-sep"></div>
    <a href="profile.html" class="user-badge">
      <img class="ub-avatar" id="nav-avatar" src="" alt="" />
      <span class="ub-name" id="nav-username">â€¦</span>
      <div class="online-dot"></div>
    </a>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- All screens start hidden; JS reveals the correct one -->

<!-- OFFLINE SETUP -->
<div id="screen-offline" class="hidden setup-wrap">
  <div class="setup-card card card-elevated page-enter">
    <div class="setup-head">
      <div class="setup-ic">ğŸ¤</div>
      <div>
        <h2>Offline Mode</h2>
        <p class="text-sm text-muted">Player 1 sets the secret word â€” Player 2 guesses.</p>
      </div>
    </div>
    <div class="divider"></div>
    <div class="form-group">
      <label class="form-label">Secret Word â€” letters Aâ€“Z only</label>
      <input class="form-control" id="off-secret" type="password"
        placeholder="Type secretlyâ€¦" maxlength="12" />
    </div>
    <div class="form-group">
      <label class="form-label">Word Length (auto-detected)</label>
      <input class="form-control" id="off-len" type="number" value="?" min="2" max="12" readonly />
    </div>
    <div class="form-group">
      <label class="form-label">Max Attempts</label>
      <input class="form-control" id="off-attempts" type="number" value="6" min="3" max="10" />
    </div>
    <div class="flex gap-8 mt-16">
      <button class="btn btn-primary flex-1" onclick="startOfflineGame()">Start Game â†’</button>
      <a href="index.html" class="btn btn-ghost">Cancel</a>
    </div>
  </div>
</div>

<!-- ONLINE SETUP -->
<div id="screen-online" class="hidden setup-wrap">
  <div class="setup-card wide card card-elevated page-enter">
    <div class="setup-head">
      <div class="setup-ic">ğŸŒ</div>
      <div>
        <h2>Online Multiplayer</h2>
        <p class="text-sm text-muted">Host a room or join with a Room ID.</p>
      </div>
    </div>
    <div class="divider"></div>

    <div class="tab-strip">
      <button class="tab-btn active" id="tab-host"  onclick="switchOnlineTab('host')">Host a Room</button>
      <button class="tab-btn"        id="tab-guest" onclick="switchOnlineTab('guest')">Join a Room</button>
    </div>

    <!-- Host panel -->
    <div id="host-panel">
      <div class="form-group">
        <label class="form-label">Secret Word â€” letters Aâ€“Z only</label>
        <input class="form-control" id="h-secret" type="password"
          placeholder="Type your secret wordâ€¦" maxlength="12" />
      </div>
      <div class="flex gap-12">
        <div class="form-group flex-1">
          <label class="form-label">Max Attempts</label>
          <input class="form-control" id="h-attempts" type="number" value="6" min="3" max="10" />
        </div>
        <div class="form-group flex-1">
          <label class="form-label">
            Bet Score
            <span class="text-faint">(have: <span id="h-score-cur" class="text-accent">â€”</span>)</span>
          </label>
          <input class="form-control" id="h-bet" type="number" value="50" min="0" />
        </div>
      </div>
      <div class="flex gap-8 mt-8">
        <button class="btn btn-primary flex-1" onclick="createRoom()">Create Room â†’</button>
        <a href="index.html" class="btn btn-ghost">Cancel</a>
      </div>
    </div>

    <!-- Guest panel -->
    <div id="guest-panel" class="hidden">
      <p class="text-muted text-sm mb-16">Ask the host for their 6-character Room ID.</p>
      <div class="form-group">
        <label class="form-label">Room ID</label>
        <input class="form-control" id="g-room-id" type="text" placeholder="AB12CD" maxlength="6"
          style="font-family:var(--mono);letter-spacing:0.25em;text-transform:uppercase;
                 text-align:center;font-size:1.7rem;padding:14px;" />
      </div>
      <div class="flex gap-8 mt-8">
        <button class="btn btn-primary flex-1" onclick="joinRoom()">Join Room â†’</button>
        <a href="index.html" class="btn btn-ghost">Cancel</a>
      </div>
    </div>
  </div>
</div>

<!-- WAITING ROOM -->
<div id="screen-waiting" class="hidden setup-wrap">
  <div class="setup-card card card-elevated text-center page-enter">
    <div style="font-size:3rem;margin-bottom:12px;animation:pdot 1.5s infinite;">â³</div>
    <h2 class="mb-8">Waiting for Opponent</h2>
    <p class="text-muted text-sm mb-20">Share this Room ID with your opponent:</p>
    <div class="room-id-display mb-8" id="room-id-show" onclick="copyRoomId()">â€”â€”</div>
    <p class="text-faint text-xs mb-20">Tap to copy</p>
    <button class="btn btn-danger btn-sm" onclick="cancelRoom()">Cancel Room</button>
  </div>
</div>

<!-- DAILY SETUP -->
<div id="screen-daily" class="hidden setup-wrap">
  <div class="setup-card card card-elevated text-center page-enter">
    <div style="font-size:3rem;margin-bottom:12px;">ğŸ“…</div>
    <h2 class="mb-8">Daily Challenge</h2>
    <p class="text-muted text-sm mb-16">60 seconds. One word. Beat the clock.</p>

    <div class="card mb-16" style="background:rgba(240,180,41,0.05);border-color:rgba(240,180,41,0.18);">
      <div class="flex justify-between mb-8">
        <span class="text-muted text-sm">Reward Money</span>
        <span class="text-gold text-mono fw-700" id="d-reward-money">â€”</span>
      </div>
      <div class="flex justify-between mb-8">
        <span class="text-muted text-sm">Reward Score</span>
        <span class="text-accent text-mono fw-700" id="d-reward-score">â€”</span>
      </div>
      <div class="flex justify-between">
        <span class="text-muted text-sm">Max Attempts</span>
        <span class="text-mono fw-700" id="d-attempts">â€”</span>
      </div>
    </div>

    <div id="d-already-played" class="hidden">
      <div class="tag tag-green"
        style="display:inline-flex;padding:8px 18px;font-size:0.82rem;border-radius:var(--rS);">
        âœ“ Already completed today!
      </div>
      <p class="text-muted text-sm mt-12">Come back tomorrow for a new word.</p>
      <a href="index.html" class="btn btn-ghost btn-full mt-16">â† Back Home</a>
    </div>

    <div id="d-start-wrap">
      <button class="btn btn-gold btn-full btn-xl" onclick="startDailyGame()">âš¡ Start Challenge</button>
      <a href="index.html" class="btn btn-ghost btn-sm mt-8">Cancel</a>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="hidden">
  <div class="game-layout">

    <!-- Board column -->
    <div class="game-main">
      <div class="game-status">
        <h2 id="game-title"    class="text-display">WORD WAR</h2>
        <p  id="game-subtitle" class="text-muted">Guess the hidden word</p>
      </div>

      <!-- Timer (daily only) -->
      <div id="timer-area" class="hidden">
        <div id="timer-el"></div>
      </div>

      <!-- Tile board -->
      <div class="game-board" id="game-board"></div>

      <!-- Text input row -->
      <div class="guess-input-wrap" id="guess-input-area">
        <input class="guess-input" id="guess-input"
          type="text" placeholder="GUESS"
          autocomplete="off" autocorrect="off"
          autocapitalize="characters" spellcheck="false" />
        <button class="btn btn-primary" id="submit-btn" onclick="submitGuess()">GO</button>
      </div>

      <!-- On-screen keyboard -->
      <div class="keyboard" id="keyboard"></div>
    </div>

    <!-- Sidebar -->
    <div class="game-sidebar">

      <div class="sb-card">
        <div class="sb-title" id="sb-mode-lbl">Game Info</div>
        <div class="sb-row">
          <span class="lbl">Attempts Left</span>
          <span class="val fw-700" id="sb-attempts">â€”</span>
        </div>
        <div class="sb-row">
          <span class="lbl">Word Length</span>
          <span class="val" id="sb-len">â€”</span>
        </div>
        <div class="sb-row hidden" id="sb-bet-row">
          <span class="lbl">Bet</span>
          <span class="val text-gold" id="sb-bet">â€”</span>
        </div>
      </div>

      <!-- Opponent card (online only) -->
      <div class="sb-card hidden" id="opp-card">
        <div class="sb-title">Opponent</div>
        <div class="flex items-center gap-12">
          <img id="opp-avatar" src="" alt=""
            style="width:36px;height:36px;border-radius:50%;border:2px solid var(--b2);flex-shrink:0;" />
          <div class="min-w-0">
            <div class="fw-700 truncate" id="opp-name">â€”</div>
            <div class="text-xs text-faint" id="opp-status">Connectingâ€¦</div>
          </div>
        </div>
      </div>

      <!-- Match log (host spectator view) -->
      <div class="sb-card hidden" id="log-card">
        <div class="sb-title">Match Log</div>
        <div id="online-log"
          style="font-size:0.76rem;color:var(--text2);max-height:180px;overflow-y:auto;"></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULT OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="result-overlay" id="result-overlay">
  <div class="result-card">
    <span class="res-emoji" id="res-emoji">ğŸ†</span>
    <h2 class="res-title"   id="res-title">Victory!</h2>
    <div class="res-word"   id="res-word">WORD</div>
    <p class="res-msg text-muted" id="res-msg"></p>
    <div class="res-btns">
      <button class="btn btn-primary" onclick="playAgain()">âš¡ Play Again</button>
      <a href="index.html" class="btn btn-ghost">â† Home</a>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANNER AD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--
  FIX: The ad uses document.write() which DESTROYS the page DOM if called
  after page load. We sandbox it inside an iframe so it can't touch the
  parent document. The iframe writes to its own empty document safely.
-->
<div class="ad-banner" id="ad-banner">
  <iframe id="ad-frame" scrolling="no" title="Advertisement"></iframe>
</div>

<script type="module">
import {
  requireAuth, saveSession, avatarUrl, fmtNum,
  sha256, generateRoomId, todayStr,
  db, ref, set, get, update, onValue, off, push
} from './firebase-config.js';
import {
  showToast, evaluateGuess, buildTileRow, buildEmptyRow, shakeRow,
  updateKeyboard, buildKeyboard, CountdownTimer,
  playSound, confettiBurst, ACHIEVEMENTS, checkAchievements
} from './main.js';

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const el = (tag, attrs={}, text='') => {
  const e = document.createElement(tag);
  Object.assign(e, attrs);
  if (text) e.textContent = text;
  return e;
};

// â”€â”€ Hide loading cover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideCover() {
  const c = $('loading-cover');
  if (c) { c.style.opacity = '0'; setTimeout(() => c.remove(), 320); }
}

// â”€â”€ Auth check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = requireAuth('login.html');
if (!currentUser) { hideCover(); throw new Error('Not authenticated'); }

$('nav-username').textContent = currentUser.username;
$('nav-avatar').src = avatarUrl(currentUser.photoURL, currentUser.username);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mode         = sessionStorage.getItem('ww_mode') || 'offline';
let secretWord   = '';
let maxAttempts  = 6;
let wordLength   = 5;
let guessCount   = 0;
let gameOver     = false;
let currentGuess = '';
let timer        = null;
let roomId       = null;
let isHost       = false;
let betScore     = 0;
let _guessUnsub  = null;

// â”€â”€ Show one screen, hide all others â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  ['screen-offline','screen-online','screen-daily',
   'screen-waiting','screen-game'].forEach(s => {
    $(s).classList.toggle('hidden', s !== id);
  });
  hideCover();   // always hide loading cover when a screen is shown
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOTSTRAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  try {
    const snap = await get(ref(db, 'users/' + currentUser.uid));
    if (snap.exists()) {
      currentUser = { ...currentUser, ...snap.val() };
      saveSession(currentUser);
    }
  } catch(e) {
    // Network issue â€” continue with cached session data
    console.warn('Could not refresh user data:', e.message);
  }

  if      (mode === 'offline') { initOfflineScreen(); }
  else if (mode === 'online')  { initOnlineScreen();  }
  else if (mode === 'daily')   { await initDailyScreen(); }
  else {
    // Unknown mode â€” fall back to offline
    mode = 'offline';
    initOfflineScreen();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initOfflineScreen() {
  showScreen('screen-offline');
  $('off-secret').addEventListener('input', e => {
    $('off-len').value = e.target.value.length || '';
  });
}

window.startOfflineGame = function() {
  const raw = $('off-secret').value.trim().toUpperCase();

  if (raw.length < 2)         { showToast('Word must be at least 2 letters.', 'warn'); return; }
  if (!/^[A-Z]+$/.test(raw)) { showToast('Letters Aâ€“Z only. No numbers or symbols.', 'warn'); return; }

  secretWord  = raw;
  maxAttempts = parseInt($('off-attempts').value, 10) || 6;
  wordLength  = raw.length;

  startBoard('ğŸ¤ OFFLINE', 'Player 2: Guess the secret word!');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE â€” HOST SIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initOnlineScreen() {
  $('h-score-cur').textContent = fmtNum(currentUser.score || 0);
  showScreen('screen-online');
}

window.switchOnlineTab = function(tab) {
  $('tab-host').classList.toggle('active',    tab === 'host');
  $('tab-guest').classList.toggle('active',   tab === 'guest');
  $('host-panel').classList.toggle('hidden',  tab !== 'host');
  $('guest-panel').classList.toggle('hidden', tab !== 'guest');
};

window.createRoom = async function() {
  const secret   = $('h-secret').value.trim().toUpperCase();
  const attempts = parseInt($('h-attempts').value, 10) || 6;
  const bet      = Math.max(0, parseInt($('h-bet').value, 10) || 0);

  if (secret.length < 2)         { showToast('Enter a secret word (min 2 letters).', 'warn'); return; }
  if (!/^[A-Z]+$/.test(secret))  { showToast('Secret word: letters Aâ€“Z only.', 'warn'); return; }

  // Re-fetch score in case it changed
  const fresh = await get(ref(db, 'users/' + currentUser.uid));
  const hData = fresh.val();
  if (bet > (hData.score || 0)) { showToast('Not enough score for this bet.', 'error'); return; }

  const hash = await sha256(secret.toLowerCase());
  roomId      = generateRoomId();
  isHost      = true;
  secretWord  = secret;
  maxAttempts = attempts;
  wordLength  = secret.length;
  betScore    = bet;

  await set(ref(db, 'rooms/' + roomId), {
    host:             currentUser.username,
    hostUid:          currentUser.uid,
    guest:            null,
    guestUid:         null,
    secretWordHash:   hash,
    secretWord:       secret,           // guest reads this after join
    secretWordLength: secret.length,
    attempts,
    betScore:         bet,
    status:           'waiting',
    winner:           null,
    createdAt:        Date.now()
  });

  // Deduct host bet immediately
  if (bet > 0) {
    await update(ref(db, 'users/' + currentUser.uid), {
      score: (hData.score || 0) - bet
    });
  }

  $('room-id-show').textContent = roomId;
  showScreen('screen-waiting');
  waitForGuest();
};

window.copyRoomId = function() {
  if (!roomId) return;
  navigator.clipboard?.writeText(roomId)
    .then(() => showToast('Room ID copied! ğŸ“‹', 'success'))
    .catch(() => showToast('Copy manually: ' + roomId, 'warn'));
};

window.cancelRoom = async function() {
  if (_guessUnsub) { _guessUnsub(); _guessUnsub = null; }
  if (roomId) {
    if (betScore > 0) {
      const snap = await get(ref(db, 'users/' + currentUser.uid));
      if (snap.exists()) {
        await update(ref(db, 'users/' + currentUser.uid), {
          score: (snap.val().score || 0) + betScore
        });
      }
    }
    await update(ref(db, 'rooms/' + roomId), { status: 'cancelled' });
  }
  window.location.href = 'index.html';
};

function waitForGuest() {
  const rRef  = ref(db, 'rooms/' + roomId);
  const unsub = onValue(rRef, snap => {
    if (!snap.exists()) return;
    const room = snap.val();
    if (room.status === 'active' && room.guest) {
      unsub();
      startHostView(room);
    }
    if (room.status === 'cancelled') {
      unsub();
      showToast('Room cancelled.', 'warn');
      window.location.href = 'index.html';
    }
  });
}

function startHostView(room) {
  $('opp-card').classList.remove('hidden');
  $('log-card').classList.remove('hidden');
  $('opp-name').textContent   = room.guest;
  $('opp-avatar').src         = avatarUrl('', room.guest);
  $('opp-status').textContent = 'Guessingâ€¦';

  startBoard(`ğŸŒ HOST â€” Word: "${secretWord}"`, `${room.guest} is guessing`, false, true);
  $('sb-mode-lbl').textContent = 'ğŸŒ Online Â· Host';
  $('sb-bet-row').classList.remove('hidden');
  $('sb-bet').textContent = betScore;

  // Host only watches â€” hide input
  $('guess-input-area').classList.add('hidden');
  $('keyboard').style.display = 'none';

  listenToGuestGuesses();
}

function listenToGuestGuesses() {
  const gRef    = ref(db, 'rooms/' + roomId + '/guesses');
  let lastCount = 0;

  _guessUnsub = onValue(gRef, snap => {
    if (!snap.exists() || gameOver) return;

    const guesses = Object.values(snap.val()).sort((a, b) => a.ts - b.ts);
    const rows    = $('game-board').querySelectorAll('.guess-row');
    const log     = $('online-log');

    // Process only new guesses
    for (let i = lastCount; i < guesses.length; i++) {
      const g      = guesses[i];
      const result = evaluateGuess(secretWord, g.guess);

      if (rows[i]) buildTileRow(rows[i], g.guess, result);

      const entry = el('div', {}, g.guess.toUpperCase());
      entry.style.cssText = 'margin-bottom:3px;padding:2px 8px;background:var(--s1);border-radius:5px;font-family:var(--mono);letter-spacing:0.1em;';
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    lastCount = guesses.length;

    $('sb-attempts').textContent = maxAttempts - guesses.length;
    $('opp-status').textContent  = `${guesses.length} / ${maxAttempts} guesses`;

    // Check if guest has resolved the game
    get(ref(db, 'rooms/' + roomId)).then(rSnap => {
      if (!rSnap.exists() || gameOver) return;
      const rd = rSnap.val();
      if (rd.status === 'finished') {
        if (_guessUnsub) { _guessUnsub(); _guessUnsub = null; }
        showHostResult(rd.winner === currentUser.username, secretWord, rd.winner);
      }
    });
  });
}

function showHostResult(hostWon, word, winner) {
  if (gameOver) return;
  gameOver = true;
  if (hostWon) { confettiBurst(); playSound('win');  }
  else         {                  playSound('lose'); }
  setTimeout(() => {
    $('res-emoji').textContent = hostWon ? 'ğŸ†' : 'ğŸ’€';
    $('res-title').textContent = hostWon ? 'YOU WIN!' : 'YOU LOSE!';
    $('res-word').textContent  = word;
    $('res-msg').textContent   = hostWon
      ? `${winner} couldn't crack your word! +${betScore * 2} â­ earned.`
      : `${winner} guessed your word correctly!`;
    $('result-overlay').classList.add('open');
  }, 700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE â€” GUEST SIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.joinRoom = async function() {
  const id = $('g-room-id').value.trim().toUpperCase();
  if (id.length !== 6) { showToast('Room ID must be 6 characters.', 'warn'); return; }

  const rRef = ref(db, 'rooms/' + id);
  const snap = await get(rRef);

  if (!snap.exists())            { showToast('Room not found.', 'error'); return; }
  const room = snap.val();
  if (room.status !== 'waiting') { showToast('Room is no longer available.', 'error'); return; }
  if (room.host === currentUser.username) { showToast("You can't join your own room.", 'warn'); return; }
  if (room.guest)                { showToast('Room is already full.', 'error'); return; }

  const mySnap = await get(ref(db, 'users/' + currentUser.uid));
  const myData = mySnap.val();
  if ((room.betScore || 0) > (myData.score || 0)) {
    showToast(`Need ${room.betScore} â­ score to join this room.`, 'error'); return;
  }

  if (room.betScore > 0) {
    await update(ref(db, 'users/' + currentUser.uid), {
      score: (myData.score || 0) - room.betScore
    });
  }

  // â”€â”€ KEY FIX: populate secretWord for the guest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  roomId      = id;
  isHost      = false;
  betScore    = room.betScore        || 0;
  maxAttempts = room.attempts;
  wordLength  = room.secretWordLength;
  secretWord  = room.secretWord.toUpperCase();   // â† without this, evaluateGuess('','X') always "wins"

  await update(rRef, {
    guest:    currentUser.username,
    guestUid: currentUser.uid,
    status:   'active'
  });

  startGuestView(room);
};

function startGuestView(room) {
  $('opp-card').classList.remove('hidden');
  $('opp-name').textContent   = room.host;
  $('opp-avatar').src         = avatarUrl('', room.host);
  $('opp-status').textContent = 'Hosting';

  startBoard('ğŸŒ MULTIPLAYER', `Vs ${room.host} Â· Bet: ${room.betScore || 0} â­`);
  $('sb-mode-lbl').textContent = 'ğŸŒ Online Â· Guest';
  $('sb-bet-row').classList.remove('hidden');
  $('sb-bet').textContent = room.betScore;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initDailyScreen() {
  try {
    const today     = todayStr();
    const dailySnap = await get(ref(db, 'dailyWord'));

    if (!dailySnap.exists()) {
      showToast('No daily challenge set yet. Check back soon!', 'warn');
      $('d-start-wrap').classList.add('hidden');
      showScreen('screen-daily');
      return;
    }

    const daily = dailySnap.val();
    $('d-reward-money').textContent = 'ğŸ’° ' + (daily.rewardMoney || 50);
    $('d-reward-score').textContent = 'â­ ' + (daily.rewardScore || 100);
    $('d-attempts').textContent     = daily.attempts || 6;

    const resSnap = await get(ref(db, `dailyResults/${today}/${currentUser.username}`));
    if (resSnap.exists()) {
      $('d-already-played').classList.remove('hidden');
      $('d-start-wrap').classList.add('hidden');
    }

    window._dailyData = daily;
  } catch(e) {
    showToast('Failed to load daily challenge.', 'error');
    console.error(e);
  }
  showScreen('screen-daily');
}

window.startDailyGame = function() {
  const daily = window._dailyData;
  if (!daily) { showToast('Daily data missing.', 'error'); return; }

  secretWord  = daily.word.toUpperCase();
  maxAttempts = daily.attempts || 6;
  wordLength  = secretWord.length;

  startBoard('ğŸ“… DAILY CHALLENGE', 'â± 60 seconds â€” guess the word!', true);

  timer = new CountdownTimer({
    totalSeconds: 60,
    containerEl:  $('timer-el'),
    onEnd: () => { if (!gameOver) handleGameEnd(false, secretWord); }
  });
  timer.start();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOARD INITIALISATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startBoard(title, subtitle, showTimer = false, hostView = false) {
  showScreen('screen-game');
  $('game-title').textContent    = title;
  $('game-subtitle').textContent = subtitle;

  // Build empty tile grid
  const board = $('game-board');
  board.innerHTML = '';
  for (let i = 0; i < maxAttempts; i++) {
    const row     = el('div');
    row.className = 'guess-row';
    row.id        = `row-${i}`;
    buildEmptyRow(row, wordLength);
    board.appendChild(row);
  }

  $('sb-len').textContent      = wordLength;
  $('sb-attempts').textContent = maxAttempts;

  if (showTimer) $('timer-area').classList.remove('hidden');

  if (!hostView) {
    buildKeyboard($('keyboard'), handleKey);
    attachInput();
    setTimeout(() => $('guess-input').focus(), 200);
  }
}

function attachInput() {
  const inp     = $('guess-input');
  inp.maxLength = wordLength;
  inp.value     = '';

  // Block non-letter keys before they register
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') { submitGuess(); return; }
    if (e.key.length === 1 && !/^[a-zA-Z]$/.test(e.key)) {
      e.preventDefault();
    }
  });

  // Clean + uppercase whatever arrives (handles paste, autocomplete, etc.)
  inp.addEventListener('input', e => {
    const clean = e.target.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
    if (e.target.value !== clean) e.target.value = clean;
    updateCurrentRow(clean);
  });
}

function handleKey(k) {
  if (gameOver) return;
  const inp = $('guess-input');
  if (k === 'âŒ«') {
    inp.value = inp.value.slice(0, -1);
  } else if (k === 'ENTER') {
    submitGuess(); return;
  } else if (/^[A-Z]$/.test(k) && inp.value.length < wordLength) {
    inp.value += k;
    playSound('type');
  }
  updateCurrentRow(inp.value);
}

function updateCurrentRow(val) {
  currentGuess = val.toUpperCase();
  const row    = $(`row-${guessCount}`);
  if (!row) return;
  row.querySelectorAll('.tile').forEach((t, i) => {
    t.textContent = currentGuess[i] || '';
    t.className   = 'tile' + (currentGuess[i] ? ' filled' : ' empty');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT GUESS â€” core loop, fixed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.submitGuess = async function() {
  if (gameOver) return;

  const inp   = $('guess-input');
  const guess = inp.value.toUpperCase().trim();

  // Length check
  if (guess.length !== wordLength) {
    showToast(`Enter a ${wordLength}-letter word.`, 'warn');
    shakeRow($(`row-${guessCount}`));
    return;
  }

  // Letters-only check
  if (!/^[A-Z]+$/.test(guess)) {
    showToast('Only letters Aâ€“Z allowed.', 'warn');
    shakeRow($(`row-${guessCount}`));
    inp.value = ''; updateCurrentRow('');
    return;
  }

  // Prevent double-submit
  inp.disabled = true;
  $('submit-btn').disabled = true;

  // Evaluate â€” requires secretWord to be populated (fixed for online guest)
  const result = evaluateGuess(secretWord, guess);
  const isWin  = result.length === wordLength && result.every(r => r === 'correct');

  // Push to Firebase for online guest (host spectator will see it)
  if (mode === 'online' && !isHost) {
    await push(ref(db, 'rooms/' + roomId + '/guesses'), { guess, ts: Date.now() });
  }

  // Render tiles + keyboard
  buildTileRow($(`row-${guessCount}`), guess, result);
  updateKeyboard($('keyboard'), guess, result);
  playSound(isWin ? 'correct' : (result.includes('correct') || result.includes('present')) ? 'present' : 'absent');

  guessCount++;
  $('sb-attempts').textContent = maxAttempts - guessCount;
  inp.value    = '';
  currentGuess = '';

  if (isWin)                       { handleGameEnd(true,  guess); return; }
  if (guessCount >= maxAttempts)   { handleGameEnd(false, guess); return; }

  // Game continues â€” re-enable
  inp.disabled = false;
  $('submit-btn').disabled = false;
  inp.focus();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME END â€” fires at most once
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleGameEnd(won, finalGuess) {
  if (gameOver) return;
  gameOver = true;

  if (timer) timer.stop();
  if (_guessUnsub) { _guessUnsub(); _guessUnsub = null; }

  $('guess-input-area').classList.add('hidden');
  $('keyboard').innerHTML = '';

  if (won) { confettiBurst(); playSound('win');  }
  else     {                  playSound('lose'); }

  const today   = todayStr();
  const userRef = ref(db, 'users/' + currentUser.uid);
  const uSnap   = await get(userRef);
  const ud      = uSnap.val();
  const updates = { totalGames: (ud.totalGames || 0) + 1 };
  let   rewardMsg = '';

  // â”€â”€ OFFLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (mode === 'offline') {
    if (won) { updates.wins   = (ud.wins   || 0) + 1; }
    else     { updates.losses = (ud.losses || 0) + 1; }
  }

  // â”€â”€ ONLINE GUEST (writes outcome) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if (mode === 'online' && !isHost) {
    if (won) {
      updates.wins  = (ud.wins  || 0) + 1;
      updates.score = (ud.score || 0) + betScore * 2;
      rewardMsg     = `+${betScore * 2} â­`;

      const rSnap = await get(ref(db, 'rooms/' + roomId));
      if (rSnap.exists() && rSnap.val().hostUid) {
        const hSnap = await get(ref(db, 'users/' + rSnap.val().hostUid));
        if (hSnap.exists()) {
          await update(ref(db, 'users/' + rSnap.val().hostUid), {
            losses: (hSnap.val().losses || 0) + 1,
            totalGames: (hSnap.val().totalGames || 0) + 1
          });
        }
      }
      await update(ref(db, 'rooms/' + roomId), { status: 'finished', winner: currentUser.username });

    } else {
      updates.losses = (ud.losses || 0) + 1;

      const rSnap = await get(ref(db, 'rooms/' + roomId));
      if (rSnap.exists()) {
        const rd = rSnap.val();
        if (rd.hostUid) {
          const hSnap = await get(ref(db, 'users/' + rd.hostUid));
          if (hSnap.exists()) {
            await update(ref(db, 'users/' + rd.hostUid), {
              wins:       (hSnap.val().wins       || 0) + 1,
              score:      (hSnap.val().score      || 0) + betScore * 2,
              totalGames: (hSnap.val().totalGames || 0) + 1
            });
          }
        }
        await update(ref(db, 'rooms/' + roomId), { status: 'finished', winner: rd.host });
      }
    }
  }

  // â”€â”€ ONLINE HOST â€” outcome managed by guest; host sees via watcher â”€â”€
  else if (mode === 'online' && isHost) {
    return;   // don't show overlay here â€” showHostResult() does it
  }

  // â”€â”€ DAILY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if (mode === 'daily') {
    const daily = window._dailyData;
    await set(ref(db, `dailyResults/${today}/${currentUser.username}`), {
      result: won ? 'win' : 'lose', timestamp: Date.now()
    });
    if (won) {
      updates.wins   = (ud.wins   || 0) + 1;
      updates.money  = (ud.money  || 0) + (daily.rewardMoney || 0);
      updates.score  = (ud.score  || 0) + (daily.rewardScore || 0);
      rewardMsg = `+${daily.rewardMoney} ğŸ’°  +${daily.rewardScore} â­`;
    } else {
      updates.losses = (ud.losses || 0) + 1;
    }
  }

  await update(userRef, updates);

  // Check achievements
  const fresh = await get(userRef);
  saveSession({ uid: currentUser.uid, ...fresh.val() });
  const newAch = await checkAchievements(fresh.val(), currentUser.uid, db, ref, update);
  if (newAch.length) {
    const a = ACHIEVEMENTS.find(x => x.id === newAch[0]);
    if (a) setTimeout(() => showToast(`ğŸ– ${a.label} unlocked!`, 'success', 4500), 1800);
  }

  // Show result overlay
  setTimeout(() => {
    $('res-emoji').textContent = won ? 'ğŸ†' : 'ğŸ’€';
    $('res-title').textContent = won ? 'VICTORY!' : 'DEFEATED!';
    $('res-word').textContent  = secretWord;
    $('res-msg').textContent   = won
      ? `Solved in ${guessCount} attempt${guessCount !== 1 ? 's' : ''}! ${rewardMsg}`
      : `The word was: ${secretWord}`;
    $('result-overlay').classList.add('open');
  }, 700);
}

window.playAgain = function() {
  $('result-overlay').classList.remove('open');
  window.location.href = 'game.html';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AD BANNER â€” injected into iframe to prevent document.write
// destroying the parent page DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function injectAd() {
  const frame = $('ad-frame');
  if (!frame) return;

  // Write a minimal HTML doc into the iframe; the ad script's
  // document.write() targets the iframe document, not the parent.
  const adCode = `<!DOCTYPE html><html><head>
    <style>body{margin:0;padding:0;background:#0e0e1e;display:flex;align-items:center;justify-content:center;height:50px;overflow:hidden;}</style>
    </head><body>
    <script type="text/javascript">
    var __jscp=function(){for(var b=0,a=window;a!=a.parent;)++b,a=a.parent;if(a=window.parent==window?document.URL:document.referrer){var c=a.indexOf("://");0<=c&&(a=a.substring(c+3));c=a.indexOf("/");0<=c&&(a=a.substring(0,c))}var b={pu:a,"if":b,rn:new Number(Math.floor(99999999*Math.random())+1)},a=[],d;for(d in b)a.push(d+"="+encodeURIComponent(b[d]));return encodeURIComponent(a.join("&"))};
    document.write('<scr'+'ipt type="text/javascript" src="//cpm.ezmob.com/tag?zone_id=338024&size=320x50&subid=&j='+__jscp()+'"></scr'+'ipt>');
    <\/script>
    </body></html>`;

  // Use srcdoc if supported, otherwise blob URL
  if ('srcdoc' in frame) {
    frame.srcdoc = adCode;
  } else {
    const blob = new Blob([adCode], { type: 'text/html' });
    frame.src  = URL.createObjectURL(blob);
  }
}

// â”€â”€ Start everything â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init().catch(e => {
  console.error('Game init failed:', e);
  showToast('Something went wrong. Please refresh.', 'error');
  hideCover();
});

injectAd();
</script>
</body>
</html>
