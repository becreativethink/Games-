<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Game</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <a href="index.html" class="nav-logo"><span class="w1">WORD</span><span class="w2">WAR</span></a>
  <div class="nav-links">
    <a href="index.html" class="nav-link m-show">â† Home</a>
    <div class="nav-sep"></div>
    <a href="profile.html" class="user-badge">
      <img class="ub-avatar" id="nav-avatar" src="" alt="" />
      <span class="ub-name"  id="nav-username">â€¦</span>
      <div class="online-dot"></div>
    </a>
  </div>
</nav>

<!-- â”€â”€â”€ SETUP SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<!-- Offline setup -->
<div id="screen-offline-setup" class="hidden setup-wrap">
  <div class="setup-card card card-elevated">
    <div class="setup-head">
      <div class="setup-ic">ğŸ¤</div>
      <div>
        <h2>Offline Mode</h2>
        <p class="text-sm text-muted">Player 1 sets the word, Player 2 guesses.</p>
      </div>
    </div>
    <div class="divider"></div>
    <div class="form-group">
      <label class="form-label">Secret Word (hidden)</label>
      <input class="form-control" id="off-secret" type="password" placeholder="Type secretlyâ€¦" maxlength="10" />
    </div>
    <div class="form-group">
      <label class="form-label">Word Length (auto)</label>
      <input class="form-control" id="off-len" type="number" value="5" min="3" max="10" readonly />
    </div>
    <div class="form-group">
      <label class="form-label">Max Attempts</label>
      <input class="form-control" id="off-attempts" type="number" value="6" min="3" max="10" />
    </div>
    <div class="flex gap-8 mt-16">
      <button class="btn btn-primary flex-1" onclick="startOfflineGame()">Start Game â†’</button>
      <a href="index.html" class="btn btn-ghost">Cancel</a>
    </div>
  </div>
</div>

<!-- Online setup -->
<div id="screen-online-setup" class="hidden setup-wrap">
  <div class="setup-card wide card card-elevated">
    <div class="setup-head">
      <div class="setup-ic">ğŸŒ</div>
      <div>
        <h2>Online Multiplayer</h2>
        <p class="text-sm text-muted">Host a room or join with a Room ID.</p>
      </div>
    </div>
    <div class="divider"></div>

    <div class="tab-strip">
      <button class="tab-btn active" id="tab-host"  onclick="switchOnlineTab('host')">Host a Room</button>
      <button class="tab-btn"        id="tab-guest" onclick="switchOnlineTab('guest')">Join a Room</button>
    </div>

    <!-- Host -->
    <div id="host-panel">
      <div class="form-group">
        <label class="form-label">Secret Word (opponent must guess this)</label>
        <input class="form-control" id="host-secret" type="password" placeholder="Type your secret wordâ€¦" maxlength="10" />
      </div>
      <div class="flex gap-12">
        <div class="form-group flex-1">
          <label class="form-label">Max Attempts</label>
          <input class="form-control" id="host-attempts" type="number" value="6" min="3" max="10" />
        </div>
        <div class="form-group flex-1">
          <label class="form-label">Bet Score (you have: <span id="host-current-score" class="text-accent">â€”</span>)</label>
          <input class="form-control" id="host-bet" type="number" value="50" min="0" />
        </div>
      </div>
      <div class="flex gap-8 mt-8">
        <button class="btn btn-primary flex-1" onclick="createRoom()">Create Room â†’</button>
        <a href="index.html" class="btn btn-ghost">Cancel</a>
      </div>
    </div>

    <!-- Guest -->
    <div id="guest-panel" class="hidden">
      <p class="text-muted text-sm mb-16">Ask the host for their 6-character Room ID.</p>
      <div class="form-group">
        <label class="form-label">Room ID</label>
        <input class="form-control" id="guest-room-id" type="text" placeholder="AB12CD" maxlength="6"
          style="font-family:var(--mono);letter-spacing:0.25em;text-transform:uppercase;text-align:center;font-size:1.6rem;padding:14px;" />
      </div>
      <div class="flex gap-8 mt-8">
        <button class="btn btn-primary flex-1" onclick="joinRoom()">Join Room â†’</button>
        <a href="index.html" class="btn btn-ghost">Cancel</a>
      </div>
    </div>
  </div>
</div>

<!-- Waiting room -->
<div id="screen-waiting" class="hidden setup-wrap">
  <div class="setup-card card card-elevated text-center">
    <div style="font-size:3rem;margin-bottom:12px;">â³</div>
    <h2 class="mb-8">Waiting for Opponent</h2>
    <p class="text-muted text-sm mb-16">Share this Room ID:</p>

    <div class="room-id-display mb-4" id="room-id-show" onclick="copyRoomId()" title="Click to copy">â€”</div>
    <p class="text-faint text-xs mb-20">Click to copy to clipboard</p>

    <button class="btn btn-danger btn-sm" onclick="cancelRoom()">Cancel Room</button>
  </div>
</div>

<!-- Daily setup -->
<div id="screen-daily-setup" class="hidden setup-wrap">
  <div class="setup-card card card-elevated text-center">
    <div style="font-size:3rem;margin-bottom:12px;">ğŸ“…</div>
    <h2 class="mb-8">Daily Challenge</h2>
    <p class="text-muted text-sm mb-16">60 seconds. One word. Beat the clock.</p>

    <div class="card" style="background:rgba(240,180,41,0.05);border-color:rgba(240,180,41,0.18);margin-bottom:16px;">
      <div class="flex justify-between mb-8">
        <span class="text-muted text-sm">Reward Money</span>
        <span class="text-gold text-mono fw-700" id="daily-reward-money">â€”</span>
      </div>
      <div class="flex justify-between">
        <span class="text-muted text-sm">Reward Score</span>
        <span class="text-accent text-mono fw-700" id="daily-reward-score">â€”</span>
      </div>
    </div>

    <div id="daily-already-played" class="hidden">
      <div class="tag tag-green" style="display:inline-flex;padding:8px 16px;font-size:0.82rem;border-radius:var(--rS);">
        âœ“ Already completed today!
      </div>
      <p class="text-muted text-sm mt-12">Come back tomorrow for a new word.</p>
      <a href="index.html" class="btn btn-ghost btn-full mt-16">â† Back Home</a>
    </div>

    <div id="daily-start-wrap">
      <button class="btn btn-gold btn-full btn-lg" onclick="startDailyGame()">Start Challenge â†’</button>
      <a href="index.html" class="btn btn-ghost btn-sm mt-8">Cancel</a>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ GAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="screen-game" class="hidden">
  <div class="game-layout">

    <!-- Main board column -->
    <div class="game-main">
      <div class="game-status">
        <h2 id="game-title">WordWar</h2>
        <p class="text-muted" id="game-subtitle">Guess the hidden word</p>
      </div>

      <!-- Timer -->
      <div id="timer-area" class="hidden">
        <div id="timer-el"></div>
      </div>

      <!-- Board -->
      <div class="game-board" id="game-board"></div>

      <!-- Input -->
      <div class="guess-input-wrap" id="guess-input-area">
        <input class="guess-input" id="guess-input" type="text"
          placeholder="TYPE GUESS" maxlength="10"
          autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false" />
        <button class="btn btn-primary" id="submit-btn" onclick="submitGuess()">GO</button>
      </div>

      <!-- Keyboard -->
      <div class="keyboard" id="keyboard"></div>
    </div>

    <!-- Sidebar -->
    <div class="game-sidebar">

      <div class="sb-card">
        <div class="sb-card-title" id="sidebar-mode-label">Game Info</div>
        <div class="sb-row">
          <span class="lbl">Attempts used</span>
          <span class="val" id="sb-attempts">0 / â€”</span>
        </div>
        <div class="sb-row">
          <span class="lbl">Word length</span>
          <span class="val" id="sb-len">â€”</span>
        </div>
        <div class="sb-row hidden" id="sb-bet-row">
          <span class="lbl">Bet</span>
          <span class="val text-gold" id="sb-bet">â€”</span>
        </div>
      </div>

      <div class="sb-card hidden" id="opponent-card">
        <div class="sb-card-title">Opponent</div>
        <div class="flex items-center gap-12">
          <img id="opp-avatar" src="" alt=""
               style="width:36px;height:36px;border-radius:50%;border:2px solid var(--b1);flex-shrink:0;" />
          <div class="min-w-0">
            <div id="opp-name" class="fw-700 truncate">â€”</div>
            <div class="text-xs text-faint" id="opp-status">Waitingâ€¦</div>
          </div>
        </div>
      </div>

      <div class="sb-card hidden" id="online-log-card">
        <div class="sb-card-title">Match Log</div>
        <div id="online-log" style="font-size:0.78rem;color:var(--text2);max-height:180px;overflow-y:auto;"></div>
      </div>

    </div>
  </div>
</div>

<!-- â”€â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="result-overlay" id="result-overlay">
  <div class="result-card">
    <span class="res-emoji" id="res-emoji">ğŸ†</span>
    <h2 class="res-title" id="res-title">Victory!</h2>
    <div class="res-word" id="res-word">WORD</div>
    <p class="res-msg text-muted" id="res-msg"></p>
    <div class="res-btns">
      <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
      <a href="index.html" class="btn btn-ghost">Home</a>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SCRIPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script type="module">
import {
  requireAuth, loadSession, saveSession,
  db, ref, set, get, update, onValue, off, push,
  sha256, generateRoomId, todayStr
} from './firebase-config.js';
import {
  showToast, evaluateGuess, buildTileRow, buildEmptyRow, shakeRow,
  updateKeyboard, buildKeyboard, CountdownTimer,
  playSound, avatarUrl, fmtNum
} from './main.js';

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = requireAuth('login.html');
if (!currentUser) throw new Error('Not authenticated');

document.getElementById('nav-username').textContent = currentUser.username;
document.getElementById('nav-avatar').src = avatarUrl(currentUser.photoURL, currentUser.username);

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode        = sessionStorage.getItem('ww_mode') || 'offline';
let secretWord  = '';
let maxAttempts = 6;
let wordLength  = 5;
let guessCount  = 0;
let gameOver    = false;
let currentGuess= '';
let timer       = null;
let roomId      = null;
let isHost      = false;
let roomListener= null;
let betScore    = 0;

// â”€â”€ Screen switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  ['screen-offline-setup','screen-online-setup','screen-daily-setup','screen-waiting','screen-game']
    .forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id));
}

// â”€â”€ Init by mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  if (mode === 'offline') {
    showScreen('screen-offline-setup');
    document.getElementById('off-secret').addEventListener('input', e => {
      document.getElementById('off-len').value = e.target.value.length || 5;
    });

  } else if (mode === 'online') {
    const snap = await get(ref(db, 'users/' + currentUser.uid));
    if (snap.exists()) {
      currentUser = { ...currentUser, ...snap.val() };
      saveSession(currentUser);
      document.getElementById('host-current-score').textContent = fmtNum(currentUser.score);
    }
    showScreen('screen-online-setup');

  } else if (mode === 'daily') {
    await loadDailySetup();
    showScreen('screen-daily-setup');
  }
}

// â”€â”€ Offline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startOfflineGame = function() {
  const word = document.getElementById('off-secret').value.trim().toUpperCase();
  if (word.length < 3) { showToast('Word must be at least 3 letters.', 'warn'); return; }
  if (!/^[A-Z]+$/.test(word)) { showToast('Letters only please.', 'warn'); return; }
  secretWord  = word;
  maxAttempts = parseInt(document.getElementById('off-attempts').value, 10);
  wordLength  = word.length;
  initBoard('ğŸ¤ Offline Mode', 'Player 2: Guess the secret word!', false);
};

// â”€â”€ Online â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchOnlineTab = function(tab) {
  document.getElementById('tab-host').classList.toggle('active', tab === 'host');
  document.getElementById('tab-guest').classList.toggle('active', tab === 'guest');
  document.getElementById('host-panel').classList.toggle('hidden', tab !== 'host');
  document.getElementById('guest-panel').classList.toggle('hidden', tab !== 'guest');
};

window.createRoom = async function() {
  const secret = document.getElementById('host-secret').value.trim().toUpperCase();
  if (secret.length < 3) { showToast('Enter a valid secret word.', 'warn'); return; }
  if (!/^[A-Z]+$/.test(secret)) { showToast('Letters only please.', 'warn'); return; }

  const attempts = parseInt(document.getElementById('host-attempts').value, 10);
  const bet = parseInt(document.getElementById('host-bet').value, 10) || 0;

  const snap = await get(ref(db, 'users/' + currentUser.uid));
  const hostData = snap.val();
  if (bet > (hostData.score || 0)) { showToast('Insufficient score for this bet.', 'error'); return; }

  const hash = await sha256(secret.toLowerCase());
  roomId   = generateRoomId();
  isHost   = true;
  secretWord  = secret;
  maxAttempts = attempts;
  wordLength  = secret.length;
  betScore    = bet;

  await set(ref(db, 'rooms/' + roomId), {
    host: currentUser.username, hostUid: currentUser.uid,
    guest: null, guestUid: null,
    secretWordHash: hash, secretWordLength: secret.length,
    attempts, betScore: bet,
    guesses: {}, status: 'waiting',
    winner: null, createdAt: Date.now()
  });

  if (bet > 0) await update(ref(db, 'users/' + currentUser.uid), { score: hostData.score - bet });

  document.getElementById('room-id-show').textContent = roomId;
  showScreen('screen-waiting');
  listenForGuest();
};

window.copyRoomId = function() {
  navigator.clipboard.writeText(roomId).then(() => showToast('Room ID copied!', 'success'));
};

window.cancelRoom = async function() {
  if (!roomId) { window.location.href = 'index.html'; return; }
  const snap = await get(ref(db, 'users/' + currentUser.uid));
  if (betScore > 0) await update(ref(db, 'users/' + currentUser.uid), { score: snap.val().score + betScore });
  await update(ref(db, 'rooms/' + roomId), { status: 'cancelled' });
  if (roomListener) off(ref(db, 'rooms/' + roomId));
  window.location.href = 'index.html';
};

function listenForGuest() {
  const rRef = ref(db, 'rooms/' + roomId);
  roomListener = onValue(rRef, snap => {
    if (!snap.exists()) return;
    const room = snap.val();
    if (room.guest && room.status === 'active') {
      off(rRef);
      initOnlineGameHost(room);
    }
    if (room.status === 'cancelled') {
      showToast('Room cancelled.', 'warn');
      window.location.href = 'index.html';
    }
  });
}

window.joinRoom = async function() {
  const id = document.getElementById('guest-room-id').value.trim().toUpperCase();
  if (id.length !== 6) { showToast('Room ID must be 6 characters.', 'warn'); return; }

  const rRef = ref(db, 'rooms/' + id);
  const snap = await get(rRef);
  if (!snap.exists()) { showToast('Room not found.', 'error'); return; }

  const room = snap.val();
  if (room.status !== 'waiting') { showToast('Room is not available.', 'error'); return; }
  if (room.host === currentUser.username) { showToast("You can't join your own room.", 'warn'); return; }

  const mySnap = await get(ref(db, 'users/' + currentUser.uid));
  const myData = mySnap.val();
  if ((room.betScore || 0) > (myData.score || 0)) {
    showToast(`Need at least ${room.betScore} score to join.`, 'error'); return;
  }

  if (room.betScore > 0) await update(ref(db, 'users/' + currentUser.uid), { score: myData.score - room.betScore });

  roomId      = id;
  isHost      = false;
  betScore    = room.betScore || 0;
  maxAttempts = room.attempts;
  wordLength  = room.secretWordLength;

  await update(rRef, { guest: currentUser.username, guestUid: currentUser.uid, status: 'active' });

  initOnlineGameGuest(room, id);
};

function initOnlineGameHost(room) {
  document.getElementById('opponent-card').classList.remove('hidden');
  document.getElementById('online-log-card').classList.remove('hidden');
  document.getElementById('opp-name').textContent = room.guest;
  document.getElementById('opp-avatar').src = avatarUrl('', room.guest);

  initBoard('ğŸŒ Hosting Room', `Opponent ${room.guest} is guessing`, false, true);
  document.getElementById('sidebar-mode-label').textContent = 'ğŸŒ Online Â· Host';
  document.getElementById('sb-bet-row').classList.remove('hidden');
  document.getElementById('sb-bet').textContent = room.betScore;
  document.getElementById('guess-input-area').classList.add('hidden');
  document.getElementById('keyboard').classList.add('hidden');

  listenForGuestGuesses(room);
}

function initOnlineGameGuest(room, id) {
  document.getElementById('opponent-card').classList.remove('hidden');
  document.getElementById('opp-name').textContent = room.host;
  document.getElementById('opp-avatar').src = avatarUrl('', room.host);

  maxAttempts = room.attempts;
  wordLength  = room.secretWordLength;
  roomId      = id;

  initBoard('ğŸŒ Online Multiplayer', `Vs ${room.host} Â· Bet: ${room.betScore} â­`, false);
  document.getElementById('sidebar-mode-label').textContent = 'ğŸŒ Online Â· Guest';
  document.getElementById('sb-bet-row').classList.remove('hidden');
  document.getElementById('sb-bet').textContent = room.betScore;

  window._onlineGuest = true;
}

function listenForGuestGuesses(room) {
  const guessRef = ref(db, 'rooms/' + roomId + '/guesses');
  onValue(guessRef, snap => {
    if (!snap.exists()) return;
    const guesses = Object.values(snap.val()).sort((a,b) => a.ts - b.ts);
    const log = document.getElementById('online-log');
    log.innerHTML = guesses.map(g =>
      `<div style="margin-bottom:3px;padding:3px 8px;background:var(--s1);border-radius:5px;font-family:var(--mono);letter-spacing:0.1em;">
        ${g.guess.toUpperCase()}
      </div>`
    ).join('');

    const board = document.getElementById('game-board');
    const rows  = board.querySelectorAll('.guess-row');
    guesses.forEach((g, i) => {
      if (!rows[i]) return;
      const result = evaluateGuess(secretWord, g.guess);
      buildTileRow(rows[i], g.guess, result);
      if (result.every(r => r === 'correct')) handleGameEnd(false, g.guess);
      if (i === maxAttempts - 1 && !result.every(r => r === 'correct')) handleGameEnd(true, secretWord);
    });

    document.getElementById('opp-status').textContent = `${guesses.length} guess${guesses.length !== 1 ? 'es' : ''} made`;
  });
}

// â”€â”€ Daily â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDailySetup() {
  const today     = todayStr();
  const dailySnap = await get(ref(db, 'dailyWord'));
  if (!dailySnap.exists()) { showToast('No daily challenge set yet.', 'warn'); return; }
  const daily = dailySnap.val();

  document.getElementById('daily-reward-money').textContent = 'ğŸ’° ' + daily.rewardMoney;
  document.getElementById('daily-reward-score').textContent = 'â­ ' + daily.rewardScore;

  const resultSnap = await get(ref(db, `dailyResults/${today}/${currentUser.username}`));
  if (resultSnap.exists()) {
    document.getElementById('daily-already-played').classList.remove('hidden');
    document.getElementById('daily-start-wrap').classList.add('hidden');
  }

  window._dailyData = daily;
}

window.startDailyGame = async function() {
  const daily = window._dailyData;
  if (!daily) { showToast('Daily challenge not available.', 'error'); return; }
  secretWord  = daily.word.toUpperCase();
  maxAttempts = daily.attempts || 6;
  wordLength  = secretWord.length;

  initBoard('ğŸ“… Daily Challenge', '60 seconds â€” guess the word!', true);

  timer = new CountdownTimer({
    totalSeconds: 60,
    containerEl: document.getElementById('timer-el'),
    onEnd: () => { if (!gameOver) handleGameEnd(false, secretWord); }
  });
  timer.start();
};

// â”€â”€ Board init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBoard(title, subtitle, showTimer = false, hostView = false) {
  showScreen('screen-game');
  document.getElementById('game-title').textContent    = title;
  document.getElementById('game-subtitle').textContent = subtitle;

  const board = document.getElementById('game-board');
  board.innerHTML = '';
  for (let i = 0; i < maxAttempts; i++) {
    const row = document.createElement('div');
    row.className = 'guess-row';
    row.id = `row-${i}`;
    buildEmptyRow(row, wordLength);
    board.appendChild(row);
  }

  document.getElementById('sb-len').textContent = wordLength;
  document.getElementById('sb-attempts').textContent = `0 / ${maxAttempts}`;

  if (showTimer) document.getElementById('timer-area').classList.remove('hidden');
  if (!hostView) buildKeyboard(document.getElementById('keyboard'), handleKey);

  const input = document.getElementById('guess-input');
  input.maxLength = wordLength;
  input.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
    updateCurrentRow(e.target.value);
  });
  input.addEventListener('keydown', e => { if (e.key === 'Enter') submitGuess(); });
  setTimeout(() => input.focus(), 100);
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleKey(k) {
  if (gameOver) return;
  const input = document.getElementById('guess-input');
  if (k === 'âŒ«') {
    input.value = input.value.slice(0, -1);
  } else if (k === 'ENTER') {
    submitGuess(); return;
  } else if (input.value.length < wordLength) {
    input.value += k;
    playSound('type');
  }
  updateCurrentRow(input.value);
}

function updateCurrentRow(val) {
  currentGuess = val.toUpperCase();
  const row = document.getElementById(`row-${guessCount}`);
  if (!row) return;
  row.querySelectorAll('.tile').forEach((t, i) => {
    t.textContent = currentGuess[i] || '';
    t.className   = 'tile' + (currentGuess[i] ? ' filled' : '');
  });
}

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.submitGuess = async function() {
  if (gameOver) return;
  const input = document.getElementById('guess-input');
  const guess = input.value.toUpperCase().trim();

  if (guess.length !== wordLength) {
    showToast(`Word must be ${wordLength} letters.`, 'warn');
    const row = document.getElementById(`row-${guessCount}`);
    if (row) shakeRow(row);
    return;
  }

  if (mode === 'online' && !isHost) {
    await push(ref(db, 'rooms/' + roomId + '/guesses'), { guess, ts: Date.now() });
  }

  const result = evaluateGuess(secretWord, guess);
  buildTileRow(document.getElementById(`row-${guessCount}`), guess, result);
  updateKeyboard(document.getElementById('keyboard'), guess, result);

  playSound(result.every(r => r === 'correct') ? 'correct' : result.includes('correct') || result.includes('present') ? 'present' : 'absent');

  guessCount++;
  document.getElementById('sb-attempts').textContent = `${guessCount} / ${maxAttempts}`;
  input.value  = '';
  currentGuess = '';

  if (result.every(r => r === 'correct')) {
    handleGameEnd(true, guess);
  } else if (guessCount >= maxAttempts) {
    handleGameEnd(false, guess);
  }
};

// â”€â”€ Game end â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleGameEnd(won, finalGuess) {
  if (gameOver) return;
  gameOver = true;
  if (timer) timer.stop();

  document.getElementById('guess-input-area').classList.add('hidden');
  document.getElementById('keyboard').innerHTML = '';

  playSound(won ? 'win' : 'lose');

  const today   = todayStr();
  const userRef = ref(db, 'users/' + currentUser.uid);
  const snap    = await get(userRef);
  const ud      = snap.val();
  const updates = { totalGames: (ud.totalGames || 0) + 1 };
  let rewardMsg = '';

  if (mode === 'offline') {
    if (won) updates.wins   = (ud.wins || 0) + 1;
    else     updates.losses = (ud.losses || 0) + 1;

  } else if (mode === 'online' && !isHost) {
    if (won) {
      updates.wins  = (ud.wins || 0) + 1;
      updates.score = (ud.score || 0) + betScore * 2;
      rewardMsg = `+${betScore * 2} â­ score!`;
      const rSnap = await get(ref(db, 'rooms/' + roomId));
      const rData = rSnap.val();
      if (rData?.hostUid) {
        const hSnap = await get(ref(db, 'users/' + rData.hostUid));
        const hd    = hSnap.val();
        await update(ref(db, 'users/' + rData.hostUid), { losses: (hd.losses||0)+1, totalGames: (hd.totalGames||0)+1 });
      }
      await update(ref(db, 'rooms/' + roomId), { status: 'finished', winner: currentUser.username });
    } else {
      updates.losses = (ud.losses || 0) + 1;
      const rSnap = await get(ref(db, 'rooms/' + roomId));
      const rData = rSnap.val();
      if (rData?.hostUid) {
        const hSnap = await get(ref(db, 'users/' + rData.hostUid));
        const hd    = hSnap.val();
        await update(ref(db, 'users/' + rData.hostUid), {
          wins: (hd.wins||0)+1, score: (hd.score||0)+betScore*2, totalGames: (hd.totalGames||0)+1
        });
      }
      await update(ref(db, 'rooms/' + roomId), { status: 'finished', winner: rData?.host });
    }

  } else if (mode === 'daily') {
    const daily = window._dailyData;
    await set(ref(db, `dailyResults/${today}/${currentUser.username}`), {
      result: won ? 'win' : 'lose', timeTaken: Date.now(), timestamp: Date.now()
    });
    if (won) {
      updates.wins   = (ud.wins || 0) + 1;
      updates.money  = (ud.money || 0) + (daily.rewardMoney || 0);
      updates.score  = (ud.score || 0) + (daily.rewardScore || 0);
      rewardMsg = `+${daily.rewardMoney} ğŸ’°  +${daily.rewardScore} â­`;
    } else {
      updates.losses = (ud.losses || 0) + 1;
    }
  }

  await update(userRef, updates);
  const fresh = await get(userRef);
  saveSession({ uid: currentUser.uid, ...fresh.val() });

  setTimeout(() => {
    document.getElementById('res-emoji').textContent = won ? 'ğŸ†' : 'ğŸ’€';
    document.getElementById('res-title').textContent = won ? 'Victory!' : 'Defeated!';
    document.getElementById('res-word').textContent  = secretWord;
    document.getElementById('res-msg').textContent   = won
      ? `Solved in ${guessCount} attempt${guessCount !== 1 ? 's' : ''}! ${rewardMsg}`
      : `The word was: ${secretWord}`;
    document.getElementById('result-overlay').classList.add('open');
  }, 600);
}

window.playAgain = function() {
  document.getElementById('result-overlay').classList.remove('open');
  window.location.href = 'game.html';
};

init();
</script>
</body>
</html>
