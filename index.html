<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Leaderboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <a href="index.html" class="nav-logo"><span class="w1">WORD</span><span class="w2">WAR</span></a>
  <div class="nav-links">
    <a href="index.html"       class="nav-link">Home</a>
    <a href="leaderboard.html" class="nav-link active">Leaderboard</a>
    <a href="profile.html"     class="nav-link">Profile</a>
    <div class="nav-sep"></div>
    <a href="profile.html" class="user-badge">
      <img class="ub-avatar" id="nav-avatar" src="" alt="" />
      <span class="ub-name" id="nav-username">â€¦</span>
      <div class="online-dot"></div>
    </a>
  </div>
</nav>

<div style="max-width:780px;margin:0 auto;padding:36px 24px 60px;">

  <!-- Header -->
  <div class="flex items-center justify-between mb-24" style="flex-wrap:wrap;gap:12px;">
    <div>
      <h1>ğŸ† Leaderboard</h1>
      <p class="text-sm text-muted mt-4">Live rankings Â· Updated in real-time</p>
    </div>
    <div class="flex gap-8">
      <button class="btn btn-primary btn-sm" id="sort-score" onclick="setSort('score')">By Score</button>
      <button class="btn btn-ghost btn-sm"   id="sort-wins"  onclick="setSort('wins')">By Wins</button>
    </div>
  </div>

  <!-- Podium -->
  <div class="podium" id="podium"></div>

  <!-- Full list -->
  <div class="lb-list" id="lb-list">
    <div class="text-center text-muted" style="padding:48px;">Loading rankingsâ€¦</div>
  </div>

</div>

<script type="module">
import { requireAuth, db, ref, onValue } from './firebase-config.js';
import { avatarUrl, fmtNum } from './main.js';

const user = requireAuth('login.html');
document.getElementById('nav-username').textContent = user.username;
document.getElementById('nav-avatar').src = avatarUrl(user.photoURL, user.username);

let allUsers = [];
let sortBy   = 'score';

onValue(ref(db, 'users'), snap => {
  if (!snap.exists()) return;
  allUsers = Object.entries(snap.val())
    .map(([uid, d]) => ({ uid, ...d }))
    .filter(u => u.username);
  render();
});

window.setSort = function(by) {
  sortBy = by;
  document.getElementById('sort-score').className = by === 'score' ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm';
  document.getElementById('sort-wins').className  = by === 'wins'  ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm';
  render();
};

function render() {
  const sorted = [...allUsers].sort((a,b) => (b[sortBy]||0) - (a[sortBy]||0));

  // Podium (order: 2nd, 1st, 3rd for visual balance)
  const podiumOrder = [
    { idx: 1, cls: 'p2', medal: 'ğŸ¥ˆ', medalCls: 'silver' },
    { idx: 0, cls: 'p1', medal: 'ğŸ¥‡', medalCls: 'gold'   },
    { idx: 2, cls: 'p3', medal: 'ğŸ¥‰', medalCls: 'bronze'  },
  ];

  document.getElementById('podium').innerHTML = podiumOrder.map(({ idx, cls, medal, medalCls }) => {
    const u = sorted[idx];
    if (!u) return `<div class="podium-slot ${cls}" style="opacity:0;flex:1;max-width:170px;"></div>`;
    const isMe = u.uid === user.uid;
    return `
      <div class="podium-slot ${cls}">
        <span class="podium-medal">${medal}</span>
        <img class="podium-avatar" src="${avatarUrl(u.photoURL, u.username)}" alt="${u.username}"
             style="${isMe ? `border-color:var(--accent);box-shadow:0 0 16px var(--ag);` : ''}" />
        <div class="podium-name" ${isMe ? 'style="color:var(--accent)"' : ''}>${u.username}</div>
        <div class="podium-score">${fmtNum(u[sortBy]||0)}</div>
        <div class="podium-base"></div>
      </div>`;
  }).join('');

  // Full list
  document.getElementById('lb-list').innerHTML = sorted.map((u, i) => {
    const rank = i + 1;
    const rankClass = rank <= 3 ? `r${rank}` : '';
    const rankHtml  = rank === 1 ? `<span class="lb-rank gold">ğŸ¥‡</span>`
                    : rank === 2 ? `<span class="lb-rank silver">ğŸ¥ˆ</span>`
                    : rank === 3 ? `<span class="lb-rank bronze">ğŸ¥‰</span>`
                    : `<span class="lb-rank">#${rank}</span>`;
    const isMe = u.uid === user.uid;
    const dot  = u.isOnline ? `<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);margin-right:5px;vertical-align:middle;"></span>` : '';

    return `
      <div class="lb-item ${rankClass}" ${isMe ? 'style="border-color:rgba(109,81,245,0.35);"' : ''}>
        ${rankHtml}
        <img class="lb-avatar" src="${avatarUrl(u.photoURL, u.username)}" alt="${u.username}" />
        <div class="lb-info">
          <div class="lb-name">${dot}${u.username}${isMe ? ' <span class="tag tag-purple" style="font-size:0.6rem;padding:2px 7px;">You</span>' : ''}</div>
          <div class="lb-sub">Lv.${Math.floor((u.score||0)/500)+1} Â· ${u.totalGames||0} games played</div>
        </div>
        <div class="lb-stats">
          <div class="lb-stat">
            <span class="lb-stat-val text-accent">${fmtNum(u.score||0)}</span>
            <span class="lb-stat-lbl">Score</span>
          </div>
          <div class="lb-stat">
            <span class="lb-stat-val text-green">${fmtNum(u.wins||0)}</span>
            <span class="lb-stat-lbl">Wins</span>
          </div>
        </div>
      </div>`;
  }).join('') || '<div class="text-center text-muted" style="padding:48px;">No players yet.</div>';
}
</script>
</body>
</html>
