<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordWar â€” Profile</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <a href="index.html" class="nav-logo"><span class="w1">WORD</span><span class="w2">WAR</span></a>
  <div class="nav-links">
    <a href="index.html"       class="nav-link">Home</a>
    <a href="leaderboard.html" class="nav-link">Leaderboard</a>
    <a href="profile.html"     class="nav-link active">Profile</a>
    <div class="nav-sep"></div>
    <a href="profile.html" class="user-badge">
      <img class="ub-avatar" id="nav-avatar" src="" alt="" />
      <span class="ub-name" id="nav-username">â€¦</span>
      <div class="online-dot"></div>
    </a>
  </div>
</nav>

<div style="max-width:780px;margin:0 auto;padding:36px 24px 60px;">

  <!-- Profile card -->
  <div class="card mb-16">
    <div class="profile-header">
      <div class="profile-avatar-wrap">
        <img id="profile-avatar" class="profile-avatar" src="" alt="avatar" />
        <div class="avatar-edit-btn" onclick="document.getElementById('photo-input').click()" title="Change photo">âœï¸</div>
        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="changePhoto(event)" />
      </div>
      <div class="profile-info min-w-0">
        <div class="profile-name truncate" id="profile-username">Loadingâ€¦</div>
        <div class="profile-meta">
          <div class="status-badge">
            <span class="status-dot online"></span>
            Online
          </div>
          <span class="tag tag-purple" id="level-tag">Level 1</span>
        </div>
        <p class="text-sm text-faint" id="profile-joined">Joined â€”</p>
        <div class="lv-wrap">
          <div class="lv-info">
            <span id="lvl-from">Level 1</span>
            <span id="lvl-xp" class="text-faint">0 / 500 XP</span>
          </div>
          <div class="lv-track">
            <div class="lv-fill" id="lvl-fill" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Currency row -->
    <div class="flex gap-20" style="flex-wrap:wrap;">
      <div class="flex items-center gap-12">
        <span style="font-size:1.5rem;">ğŸ’°</span>
        <div>
          <div class="text-mono fw-700" id="p-money" style="font-size:1.25rem;">â€”</div>
          <div class="text-xs text-faint">Money</div>
        </div>
      </div>
      <div class="flex items-center gap-12">
        <span style="font-size:1.5rem;">â­</span>
        <div>
          <div class="text-mono fw-700" id="p-score" style="font-size:1.25rem;">â€”</div>
          <div class="text-xs text-faint">Score</div>
        </div>
      </div>
      <div class="flex items-center gap-12">
        <span style="font-size:1.5rem;">ğŸ…</span>
        <div>
          <div class="text-mono fw-700" id="p-rank" style="font-size:1.25rem;">â€”</div>
          <div class="text-xs text-faint">Global Rank</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stat grid -->
  <div class="stat-grid mb-16">
    <div class="stat-card">
      <span class="stat-val text-green" id="s-wins">â€”</span>
      <span class="stat-lbl">Wins</span>
    </div>
    <div class="stat-card">
      <span class="stat-val text-red" id="s-losses">â€”</span>
      <span class="stat-lbl">Losses</span>
    </div>
    <div class="stat-card">
      <span class="stat-val" id="s-total">â€”</span>
      <span class="stat-lbl">Total Games</span>
    </div>
    <div class="stat-card">
      <span class="stat-val text-yellow" id="s-wr">â€”%</span>
      <span class="stat-lbl">Win Rate</span>
    </div>
    <div class="stat-card">
      <span class="stat-val text-accent" id="s-score">â€”</span>
      <span class="stat-lbl">Score</span>
    </div>
    <div class="stat-card">
      <span class="stat-val text-gold" id="s-money">â€”</span>
      <span class="stat-lbl">Money</span>
    </div>
  </div>

  <!-- Achievements -->
  <div class="card mb-16">
    <h3 class="mb-16">ğŸ– Achievements</h3>
    <div class="badges-wrap" id="achievements-list">
      <span class="text-faint text-sm">Loadingâ€¦</span>
    </div>
  </div>

  <!-- Account actions -->
  <div class="card">
    <h3 class="mb-16">Account Settings</h3>
    <div class="flex gap-8" style="flex-wrap:wrap;">
      <a href="index.html" class="btn btn-ghost btn-sm">â† Home</a>
      <button class="btn btn-danger btn-sm" onclick="openModal('modal-delete')">Delete Account</button>
      <button class="btn btn-secondary btn-sm" onclick="doLogout()">Logout</button>
    </div>
  </div>

</div>

<!-- Delete modal -->
<div class="modal-overlay" id="modal-delete">
  <div class="modal">
    <div class="modal-head">
      <h3>âš ï¸ Delete Account</h3>
      <button class="modal-close" onclick="closeModal('modal-delete')">âœ•</button>
    </div>
    <p class="text-muted text-sm mb-16">
      This is permanent. All progress, score, and data will be deleted.
    </p>
    <div class="form-group">
      <label class="form-label">Type your username to confirm</label>
      <input class="form-control" id="del-confirm" type="text" placeholder="your_username" />
    </div>
    <div class="flex gap-8 mt-16">
      <button class="btn btn-danger flex-1" onclick="doDelete()">Delete Forever</button>
      <button class="btn btn-ghost flex-1" onclick="closeModal('modal-delete')">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import {
  requireAuth, logoutUser, deleteAccount, saveSession,
  db, ref, onValue, get, update
} from './firebase-config.js';
import { showToast, getLevel, getLevelProgress, ACHIEVEMENTS, avatarUrl, fmtNum, openModal, closeModal } from './main.js';

const user = requireAuth('login.html');
document.getElementById('nav-username').textContent = user.username;
document.getElementById('nav-avatar').src = avatarUrl(user.photoURL, user.username);

window.openModal  = openModal;
window.closeModal = closeModal;

const userRef = ref(db, 'users/' + user.uid);

onValue(userRef, snap => {
  if (!snap.exists()) return;
  const d = snap.val();
  saveSession({ uid: user.uid, ...d });

  document.getElementById('profile-username').textContent = d.username;
  const av = avatarUrl(d.photoURL, d.username);
  document.getElementById('profile-avatar').src = av;
  document.getElementById('nav-avatar').src     = av;
  document.getElementById('profile-joined').textContent = 'Joined ' + new Date(d.createdAt).toLocaleDateString();

  document.getElementById('p-money').textContent = fmtNum(d.money);
  document.getElementById('p-score').textContent = fmtNum(d.score);

  document.getElementById('s-wins').textContent   = fmtNum(d.wins);
  document.getElementById('s-losses').textContent = fmtNum(d.losses);
  document.getElementById('s-total').textContent  = fmtNum(d.totalGames);
  document.getElementById('s-score').textContent  = fmtNum(d.score);
  document.getElementById('s-money').textContent  = fmtNum(d.money);

  const wr = d.totalGames > 0 ? Math.round((d.wins / d.totalGames) * 100) : 0;
  document.getElementById('s-wr').textContent = wr + '%';

  const lvl  = getLevel(d.score);
  const pct  = getLevelProgress(d.score);
  const base = (lvl - 1) * 500;
  document.getElementById('level-tag').textContent = 'Level ' + lvl;
  document.getElementById('lvl-from').textContent  = 'Level ' + lvl;
  document.getElementById('lvl-xp').textContent    = `${(d.score||0) - base} / 500 XP`;
  document.getElementById('lvl-fill').style.width  = pct + '%';

  // Achievements
  document.getElementById('achievements-list').innerHTML = ACHIEVEMENTS.map(a => {
    const earned = a.condition(d);
    return `<div class="badge ${earned ? 'earned' : 'locked'}">
      <span>${a.icon}</span>
      <span>${a.label}</span>
      ${earned ? '' : '<span style="font-size:0.6rem;opacity:0.5;">ğŸ”’</span>'}
    </div>`;
  }).join('');
});

// Global rank
(async () => {
  const snap = await get(ref(db, 'users'));
  if (!snap.exists()) return;
  const all  = Object.values(snap.val()).filter(u => u.username).sort((a,b) => (b.score||0)-(a.score||0));
  const idx  = all.findIndex(u => u.username === user.username);
  document.getElementById('p-rank').textContent = idx >= 0 ? '#' + (idx + 1) : 'â€”';
})();

// Change photo
window.changePhoto = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 600_000) { showToast('Photo must be under 600KB.', 'warn'); return; }
  const reader = new FileReader();
  reader.onload = async ev => {
    await update(userRef, { photoURL: ev.target.result });
    showToast('Profile photo updated!', 'success');
  };
  reader.readAsDataURL(file);
};

window.doDelete = async function() {
  const val = document.getElementById('del-confirm').value.trim();
  if (val !== user.username) { showToast('Username does not match.', 'error'); return; }
  await deleteAccount(user.uid, user.username);
  showToast('Account deleted.', 'info');
  setTimeout(() => window.location.href = 'login.html', 800);
};

window.doLogout = async function() {
  await logoutUser(user.uid);
  window.location.href = 'login.html';
};
</script>
</body>
</html>
